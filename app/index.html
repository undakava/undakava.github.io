<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>忽略标题</title>

<style>
body{font-family:sans-serif;font-size:18px;}
.container{max-width:900px;margin:0 auto;padding:10px;}
textarea{width:100%;box-sizing:border-box;font-size:18px;line-height:1.6;padding:6px;}
button{margin:6px 6px 6px 0;font-size:17px;padding:6px 12px;}
select,input{font-size:17px;}
.clear-btn{background:#f66;color:#fff;padding:6px 12px;border:none;border-radius:4px;}
.section{margin:16px 0;}
.small{width:20em;height:2.4em;}
.medium{width:100%;height:48px;}

@media (max-width:768px){
body{font-size:20px;}
textarea{font-size:20px;}
button,select,input{font-size:19px;}
}
</style>
</head>

<body>

<div style="padding:10px;">
<button onclick="goProjects()">← 返回项目大厅</button>
</div>

<h1 id="pageTitle" style="text-align:center;">忽略标题</h1>

<div class="container">
<button class="clear-btn" onclick="clearData()">清理页面存储</button>
<div id="app"></div>
</div>

<script>

/* ===== 初始化 ===== */

var stage = localStorage.getItem("stage") || "preset";
var currentCharacter = Number(localStorage.getItem("currentCharacter")) || 0;
var currentVolume = Number(localStorage.getItem("currentVolume")) || 0;
var currentChapter = Number(localStorage.getItem("currentChapter")) || 0;

var data;
var currentPid=null;


/* ===== ⭐ 数据统一修复层 ===== */

function normalizeData(d){

if(!d || typeof d!=="object"){
d={preset:"",world:"",outline:"",characters:[],volumes:[]};
}

if(!Array.isArray(d.characters)) d.characters=[];
if(!Array.isArray(d.volumes)) d.volumes=[];

/* 角色至少存在一个 */
if(d.characters.length===0){
d.characters.push({name:"",importance:"",identity:"",personality:"",relations:"",traits:""});
}

/* 卷至少存在一个 */
if(d.volumes.length===0){
d.volumes.push({
desc:"",
characterArc:"",
startState:"",
goal:"",
events:"",
endState:"",
chapterCount:1,
chapters:[{summary:"",scene:"",beats:"",text:""}]
});
}

/* 修复每卷结构 */
d.volumes.forEach(v=>{
if(!Array.isArray(v.chapters)) v.chapters=[];
if(v.chapters.length===0){
v.chapters=[{summary:"",scene:"",beats:"",text:""}];
}
});

/* 修复索引越界 */
if(currentCharacter>=d.characters.length) currentCharacter=0;
if(currentVolume>=d.volumes.length) currentVolume=0;
if(currentChapter>=d.volumes[currentVolume].chapters.length) currentChapter=0;

return d;
}


/* ===== 加载项目 ===== */

function loadProjectData(){

var params=new URLSearchParams(window.location.search);
currentPid=params.get("pid");

if(currentPid){

var projects=JSON.parse(localStorage.getItem("projects"))||{};

if(!projects[currentPid]){
projects[currentPid]={name:"未命名项目",updated:Date.now(),data:null};
}

data=normalizeData(projects[currentPid].data);

projects[currentPid].data=data;
localStorage.setItem("projects",JSON.stringify(projects));

}else{

try{ data=JSON.parse(localStorage.getItem("data")); }
catch(e){ data=null; }

data=normalizeData(data);
}

}


/* ===== 保存 ===== */

function save(){

localStorage.setItem("stage",stage);
localStorage.setItem("currentCharacter",currentCharacter);
localStorage.setItem("currentVolume",currentVolume);
localStorage.setItem("currentChapter",currentChapter);

if(currentPid){

var projects=JSON.parse(localStorage.getItem("projects"))||{};
projects[currentPid].data=data;
projects[currentPid].updated=Date.now();
localStorage.setItem("projects",JSON.stringify(projects));

}else{
localStorage.setItem("data",JSON.stringify(data));
}

}


/* ===== 清理 ===== */

function clearData(){
localStorage.clear();
alert("已清理");
}


/* ===== 顶部步骤 ===== */

function drawSteps(){
return `
<div style="margin-bottom:12px;">
<button onclick="jump('preset')" ${stage==='preset'?'style="background:#111;color:#fff"':''}>前期设定</button>
<button onclick="jump('outline')" ${stage==='outline'?'style="background:#111;color:#fff"':''}>全书大纲</button>
<button onclick="jump('characters')" ${stage==='characters'?'style="background:#111;color:#fff"':''}>角色库</button>
<button onclick="jump('volume')" ${stage==='volume'?'style="background:#111;color:#fff"':''}>卷纲</button>
<button onclick="jump('chapter')" ${stage==='chapter'?'style="background:#111;color:#fff"':''}>章节细纲</button>
</div>`;
}


/* ===== 渲染 ===== */

function draw(){

var app=document.getElementById("app");


/* ===== 前期设定 ===== */

if(stage==="preset"){
app.innerHTML=drawSteps()+`
<b>前期设定</b><br><br>

世界观<br>
<textarea rows="6"
oninput="data.world=this.value;save();"
>${data.world||""}</textarea><br><br>

脑洞生成<br>
<textarea rows="6"
oninput="data.preset=this.value;save();"
>${data.preset||""}</textarea><br>

<button onclick="genIdea()">生成脑洞</button>
`;
return;
}


/* ===== 全书大纲 ===== */

if(stage==="outline"){
app.innerHTML=drawSteps()+`
<b>全书大纲</b><br><br>

<textarea rows="48"
oninput="data.outline=this.value;save();"
>${data.outline||""}</textarea><br>

<button onclick="genOutline()">生成全书大纲</button>
`;
return;
}


/* ===== 角色库 ===== */

if(stage==="characters"){

var c=data.characters[currentCharacter];

var options=data.characters.map((ch,i)=>{
var label=ch.name&&ch.name.trim()?ch.name.trim():"角色"+(i+1);
return `<option value="${i}" ${i===currentCharacter?'selected':''}>${label}</option>`;
}).join("");

app.innerHTML=drawSteps()+`
<b>角色库</b><br><br>

<button onclick="addCharacter()">＋ 新增角色</button>
<button onclick="removeCharacter()">－ 删除角色</button><br><br>

当前角色：
<select onchange="changeCharacter(this.value)">${options}</select>
<hr>

姓名<br>
<textarea class="small"
oninput="data.characters[currentCharacter].name=this.value;save();"
>${c.name||""}</textarea><br><br>

角色重要性<br>
<textarea class="small"
oninput="data.characters[currentCharacter].importance=this.value;save();"
>${c.importance||""}</textarea><br><br>

性格<br>
<textarea class="small"
oninput="data.characters[currentCharacter].personality=this.value;save();"
>${c.personality||""}</textarea><br><br>

身份<br>
<textarea class="medium"
oninput="data.characters[currentCharacter].identity=this.value;save();"
>${c.identity||""}</textarea><br><br>

核心关系<br>
<textarea class="medium"
oninput="data.characters[currentCharacter].relations=this.value;save();"
>${c.relations||""}</textarea><br><br>

人物特性<br>
<textarea class="medium"
oninput="data.characters[currentCharacter].traits=this.value;save();"
>${c.traits||""}</textarea>
`;
return;
}


/* ===== 卷纲 ===== */

if(stage==="volume"){

var html=drawSteps()+`
<b>卷纲</b><br><br>

<button onclick="addVolume()">＋ 增加一卷</button>
<button onclick="removeVolume()">－ 减少一卷</button><br><br>

当前工作卷：
<select onchange="changeVolume(this.value)">
${data.volumes.map((_,i)=>`<option value="${i}" ${i===currentVolume?'selected':''}>第 ${i+1} 卷</option>`).join("")}
</select>
<hr>
`;

var v=data.volumes[currentVolume];

html+=`
卷简介
<textarea style="height:120px"
oninput="v.desc=this.value;save();"
>${v.desc||""}</textarea><br><br>

章节数：
<input type="number" min="1"
value="${v.chapterCount||1}"
onchange="v.chapterCount=this.value;save();"
><br><br>

<button onclick="genChapterOutline(${currentVolume})">生成章节概述</button>
`;

app.innerHTML=html;
return;
}


/* ===== 章节细纲 ===== */

if(stage==="chapter"){

var v=data.volumes[currentVolume];
var c=v.chapters[currentChapter];

var volOptions=data.volumes.map((_,i)=>
`<option value="${i}" ${i===currentVolume?'selected':''}>第 ${i+1} 卷</option>`
).join("");

var chapOptions=v.chapters.map((_,i)=>
`<option value="${i}" ${i===currentChapter?'selected':''}>第 ${i+1} 章</option>`
).join("");

app.innerHTML=drawSteps()+`
<b>章节细纲</b><br><br>

第 <select onchange="changeVolume(this.value)">${volOptions}</select> 卷　
第 <select onchange="changeChapter(this.value)">${chapOptions}</select> 章<br><br>

<textarea rows="6"
oninput="c.text=this.value;save();"
>${c.text||""}</textarea>
`;

return;
}

}


/* ===== 逻辑 ===== */

function jump(s){stage=s;save();draw();}

function genIdea(){data.preset="【脑洞生成占位】";save();draw();}
function genOutline(){data.outline="【全书大纲生成占位】";save();draw();}

function addCharacter(){
data.characters.push({name:"",importance:"",identity:"",personality:"",relations:"",traits:""});
currentCharacter=data.characters.length-1;
save();draw();
}

function removeCharacter(){
if(data.characters.length>1){
data.characters.splice(currentCharacter,1);
currentCharacter=Math.max(0,currentCharacter-1);
save();draw();
}
}

function addVolume(){
data.volumes.push({
desc:"",
characterArc:"",
startState:"",
goal:"",
events:"",
endState:"",
chapterCount:1,
chapters:[{summary:"",scene:"",beats:"",text:""}]
});
currentVolume=data.volumes.length-1;
save();draw();
}

function removeVolume(){
if(data.volumes.length>1){
data.volumes.pop();
currentVolume=Math.max(0,currentVolume-1);
save();draw();
}
}

function genChapterOutline(i){
var v=data.volumes[i];
v.chapters=[];
for(let n=0;n<(v.chapterCount||1);n++){
v.chapters.push({summary:"第"+(n+1)+"章概述",scene:"",beats:"",text:""});
}
save();
draw();
}

function changeCharacter(i){currentCharacter=Number(i);save();draw();}
function changeVolume(i){currentVolume=Number(i);currentChapter=0;save();draw();}
function changeChapter(i){currentChapter=Number(i);save();draw();}

function goProjects(){window.location.href="projects.html";}

function loadProjectTitle(){
var params=new URLSearchParams(window.location.search);
var pid=params.get("pid");
if(!pid) return;

try{
var projects=JSON.parse(localStorage.getItem("projects"))||{};
if(projects[pid]&&projects[pid].name){
document.getElementById("pageTitle").innerText="《"+projects[pid].name+"》";
}
}catch(e){}
}

loadProjectData();
loadProjectTitle();
draw();

</script>
</body>
</html>