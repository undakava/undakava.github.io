<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>赛博文豪</title>
<style>
body{font-family:sans-serif;}
.container{max-width:900px;margin:0 auto;}
textarea{width:100%;box-sizing:border-box;}
button{margin:4px 6px 4px 0;}
.clear-btn{background:#f66;color:#fff;padding:6px 12px;border:none;border-radius:4px;}
</style>
</head>
<body>

<h1 style="text-align:center;">赛博文豪</h1>

<div class="container">
  <!-- 新增清理数据按钮 -->
  <button class="clear-btn" onclick="clearData()">清理页面存储（localStorage）</button>
  <div id="app"></div>
</div>

<script>
/* ===== 安全初始化 ===== */
var stage = localStorage.getItem("stage") || "preset";
var currentVolume = Number(localStorage.getItem("currentVolume")) || 0;
var data;
try {
  data = JSON.parse(localStorage.getItem("data"));
} catch(e) {
  data = null;
}
if(!data || typeof data !== "object") data = { preset:"", outline:"", volumes:[] };
if(!Array.isArray(data.volumes)) data.volumes = [];

/* ===== 保存 ===== */
function save(){
  localStorage.setItem("stage", stage);
  localStorage.setItem("currentVolume", currentVolume);
  localStorage.setItem("data", JSON.stringify(data));
}

/* ===== 清理数据按钮功能 ===== */
function clearData(){
  localStorage.clear();
  alert('网页数据已清理，请刷新页面！');
}

/* ===== 顶部步骤 ===== */
function drawSteps(){
  return '<div style="margin-bottom:12px;">' +
    '<button onclick="jump(\'preset\')" style="margin-right:6px;' + (stage==='preset'?'background:#111;color:#fff;':'background:#eee;') + '">前期设定</button>' +
    '<button onclick="jump(\'outline\')" style="margin-right:6px;' + (stage==='outline'?'background:#111;color:#fff;':'background:#eee;') + '">全书大纲</button>' +
    '<button onclick="jump(\'volume\')" style="margin-right:6px;' + (stage==='volume'?'background:#111;color:#fff;':'background:#eee;') + '">卷纲</button>' +
    '<button onclick="jump(\'chapter\')" style="margin-right:6px;' + (stage==='chapter'?'background:#111;color:#fff;':'background:#eee;') + '">章节细纲</button>' +
    '</div>';
}

/* ===== 渲染页面 ===== */
function draw(){
  var app = document.getElementById("app");
  if(!app) return;

  if(stage==="preset"){
    app.innerHTML =
      drawSteps() +
      '<b>前期设定（脑洞 + 世界观）</b><br><br>' +
      '<textarea id="main" rows="12">' + (data.preset||"") + '</textarea><br>' +
      '<button onclick="genIdea()">生成脑洞</button>' +
      '<button onclick="genWorld()">生成世界观</button>';
    return;
  }

  if(stage==="outline"){
    app.innerHTML =
      drawSteps() +
      '<b>全书大纲</b><br><br>' +
      '<textarea id="main" rows="12">' + (data.outline||"") + '</textarea><br>' +
      '<button onclick="genOutline()">生成全书大纲</button>';
    return;
  }

  if(stage==="volume"){
    var html = drawSteps() +
      '<b>卷纲</b><br><br>' +
      '<button onclick="addVolume()">＋ 增加一卷</button>' +
      '<button onclick="removeVolume()">－ 删除一卷</button>' +
      '<br><br>' +
      '<button onclick="genAllVolumeDesc()">根据全书大纲生成卷简介</button><hr>';

    for(var i=0;i<data.volumes.length;i++){
      var v = data.volumes[i];
      html += '<div style="margin-bottom:20px;">' +
        '<b>第 ' + (i+1) + ' 卷</b><br><br>' +
        '卷简介：<br>' +
        '<textarea style="width:100%;height:56px;" oninput="updateVolumeDesc(' + i + ',this.value)">' + (v.desc||"") + '</textarea><br><br>' +
        '本卷章节数：<input type="number" min="1" value="' + (v.chapterCount||10) + '" onchange="updateChapterCount(' + i + ',this.value)"><br><br>' +
        '<button onclick="genChapterOutline(' + i + ')">根据卷简介生成章节概述</button>' +
        '</div>';
    }
    app.innerHTML = html;
    return;
  }

  if(stage==="chapter"){
    app.innerHTML =
      drawSteps() +
      '<b>章节细纲</b><br>' +
      '<p>（UI 已冻结，结构保持不变）</p>';
    return;
  }
}

/* ===== 通用操作 ===== */
function jump(s){
  var input = document.getElementById("main");
  if(input) data[stage] = input.value;
  stage = s;
  save();
  draw();
}

/* ===== 前期设定占位规则 ===== */
function genIdea(){
  if(!data.preset || !data.preset.includes('脑洞生成占位')){
    // 脑洞占位插在开头
    data.preset = "【脑洞生成占位】" + (data.preset ? "\n\n" + data.preset : "");
  }
  save(); draw();
}

function genWorld(){
  if(data.preset.includes('世界观生成占位')) return; // 防止重复生成
  if(data.preset.includes('脑洞生成占位')){
    // 在脑洞占位下插入世界观占位
    data.preset = data.preset.replace('脑洞生成占位', '脑洞生成占位\n\n【世界观生成占位】');
  } else {
    // 如果脑洞占位不存在，先生成脑洞再生成世界观
    data.preset = "【脑洞生成占位】\n\n【世界观生成占位】";
  }
  save(); draw();
}

/* ===== 全书大纲 ===== */
function genOutline(){
  data.outline = "【全书大纲生成占位】";
  save(); draw();
}

/* ===== 卷纲逻辑 ===== */
function addVolume(){
  data.volumes.push({desc:"",chapterCount:10,chapters:[]});
  save(); draw();
}
function removeVolume(){
  if(data.volumes.length>0) data.volumes.pop();
  save(); draw();
}
function updateVolumeDesc(i,v){
  if(!data.volumes[i]) return;
  data.volumes[i].desc = v;
  save();
}
function updateChapterCount(i,v){
  if(!data.volumes[i]) return;
  data.volumes[i].chapterCount = Number(v) || 1;
  save();
}
function genAllVolumeDesc(){
  if(!data.outline){ alert("请先填写全书大纲"); return; }
  for(var i=0;i<data.volumes.length;i++){
    var v = data.volumes[i];
    if(!v) continue;
    v.desc = "【第 " + (i+1) + " 卷简介】\n" + data.outline;
  }
  save(); draw();
}
function genChapterOutline(i){
  var v = data.volumes[i];
  if(!v) return;
  v.chapters = [];
  var count = Number(v.chapterCount) || 1;
  for(var n=0;n<count;n++){
    v.chapters.push("第 " + (n+1) + " 章概述（占位）");
  }
  save();
}

/* ===== 启动 ===== */
draw();
</script>

</body>
</html>