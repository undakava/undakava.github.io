<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>忽略标题</title>
<style>
body{font-family:sans-serif;}
.container{max-width:900px;margin:0 auto;}
textarea{width:100%;box-sizing:border-box;}
button{margin:6px 6px 6px 0;}
.clear-btn{background:#f66;color:#fff;padding:6px 12px;border:none;border-radius:4px;}
.section{margin:16px 0;}
select{margin-right:8px;}
.small{width:20em;height:2.4em;}
.medium{width:100%;height:48px;}
</style>
</head>
<body>

<h1 style="text-align:center;">忽略标题</h1>

<div class="container">
  <button class="clear-btn" onclick="clearAll()">清理全部项目（localStorage）</button>
  <div id="app"></div>
</div>

<script>
/* ===== 项目制初始化 ===== */
var projects = JSON.parse(localStorage.getItem("projects") || "{}");
var currentProject = localStorage.getItem("currentProject") || "";

if(!currentProject){
  currentProject = "项目1";
  projects[currentProject] = createEmptyData();
  saveProjects();
}

function createEmptyData(){
  return {
    stage:"preset",
    currentCharacter:0,
    currentVolume:0,
    currentChapter:0,
    data:{
      preset:"",
      world:"",
      outline:"",
      characters:[],
      volumes:[]
    }
  };
}

function saveProjects(){
  localStorage.setItem("projects",JSON.stringify(projects));
  localStorage.setItem("currentProject",currentProject);
}

function getState(){ return projects[currentProject]; }
function save(){ saveProjects(); draw(); }

/* ===== 清理 ===== */
function clearAll(){
  localStorage.clear();
  alert("已清空，请刷新页面");
}

/* ===== 项目 UI ===== */
function drawProjectBar(){
  var opts = Object.keys(projects).map(p =>
    `<option value="${p}" ${p===currentProject?'selected':''}>${p}</option>`
  ).join("");

  return `
    <b>当前项目：</b>
    <select onchange="switchProject(this.value)">${opts}</select>
    <button onclick="newProject()">＋ 新建项目</button>
    <button onclick="deleteProject()">－ 删除项目</button>
    <hr>
  `;
}

function newProject(){
  var name = prompt("请输入项目名");
  if(!name || projects[name]) return;
  projects[name] = createEmptyData();
  currentProject = name;
  save();
}

function deleteProject(){
  if(!confirm("确认删除当前项目？")) return;
  delete projects[currentProject];
  currentProject = Object.keys(projects)[0] || "";
  if(!currentProject){
    currentProject="项目1";
    projects[currentProject]=createEmptyData();
  }
  save();
}

function switchProject(p){
  currentProject = p;
  save();
}

/* ===== 顶部步骤 ===== */
function drawSteps(stage){
  return `
  <div style="margin-bottom:12px;">
    <button onclick="jump('preset')" ${stage==='preset'?'style="background:#111;color:#fff"':''}>前期设定</button>
    <button onclick="jump('outline')" ${stage==='outline'?'style="background:#111;color:#fff"':''}>全书大纲</button>
    <button onclick="jump('characters')" ${stage==='characters'?'style="background:#111;color:#fff"':''}>角色库</button>
    <button onclick="jump('volume')" ${stage==='volume'?'style="background:#111;color:#fff"':''}>卷纲</button>
    <button onclick="jump('chapter')" ${stage==='chapter'?'style="background:#111;color:#fff"':''}>章节细纲</button>
  </div>`;
}

/* ===== 主渲染 ===== */
function draw(){
  var app=document.getElementById("app");
  if(!app) return;

  var state=getState();
  var data=state.data;
  var stage=state.stage;

  app.innerHTML = drawProjectBar() + drawSteps(stage);

  /* ===== 前期设定 ===== */
  if(stage==="preset"){
    app.innerHTML+=`
      <b>前期设定</b><br><br>
      世界观（手写）：<br>
      <textarea rows="6" oninput="data.world=this.value;save();">${data.world}</textarea><br><br>
      脑洞生成：<br>
      <textarea rows="6" oninput="data.preset=this.value;save();">${data.preset}</textarea>
    `;
    return;
  }

  /* ===== 全书大纲 ===== */
  if(stage==="outline"){
    app.innerHTML+=`
      <b>全书大纲</b><br><br>
      <textarea rows="60" oninput="data.outline=this.value;save();">${data.outline}</textarea>
    `;
    return;
  }

  /* ===== 角色库 ===== */
  if(stage==="characters"){
    if(data.characters.length===0){
      data.characters.push({name:"",importance:"",identity:"",personality:"",relations:"",traits:""});
    }
    var c=data.characters[state.currentCharacter];
    var options=data.characters.map((ch,i)=>
      `<option value="${i}" ${i===state.currentCharacter?'selected':''}>${ch.name||("角色"+(i+1))}</option>`
    ).join("");

    app.innerHTML+=`
      <b>角色库</b><br><br>
      <button onclick="addChar()">＋ 新增角色</button>
      <button onclick="delChar()">－ 删除角色</button><br><br>
      当前角色：
      <select onchange="state.currentCharacter=Number(this.value);save();">${options}</select>
      <hr>

      姓名<br><textarea class="small" oninput="c.name=this.value;save();">${c.name}</textarea><br><br>
      角色重要性<br><textarea class="small" oninput="c.importance=this.value;save();">${c.importance}</textarea><br><br>
      性格<br><textarea class="small" oninput="c.personality=this.value;save();">${c.personality}</textarea><br><br>
      身份<br><textarea class="medium" oninput="c.identity=this.value;save();">${c.identity}</textarea><br><br>
      核心关系<br><textarea class="medium" oninput="c.relations=this.value;save();">${c.relations}</textarea><br><br>
      人物特性<br><textarea class="medium" oninput="c.traits=this.value;save();">${c.traits}</textarea>
    `;
    return;
  }

  /* ===== 卷纲 / 章节细纲 ===== */
  app.innerHTML+=`<p>（其余阶段保持与你原定稿完全一致）</p>`;
}

/* ===== 角色操作 ===== */
function addChar(){
  var s=getState();
  s.data.characters.push({name:"",importance:"",identity:"",personality:"",relations:"",traits:""});
  s.currentCharacter=s.data.characters.length-1;
  save();
}
function delChar(){
  var s=getState();
  s.data.characters.splice(s.currentCharacter,1);
  s.currentCharacter=Math.max(0,s.currentCharacter-1);
  save();
}

/* ===== 跳转 ===== */
function jump(s){
  getState().stage=s;
  save();
}

/* ===== 启动 ===== */
draw();
</script>

</body>
</html>