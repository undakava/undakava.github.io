<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>忽略标题</title>
<style>
body{font-family:sans-serif;}
.container{max-width:900px;margin:0 auto;}
textarea{width:100%;box-sizing:border-box;}
button{margin:6px 6px 6px 0;}
.clear-btn{background:#f66;color:#fff;padding:6px 12px;border:none;border-radius:4px;}
.section{margin:16px 0;}
select{margin-right:8px;}
.small{width:20em;height:2.4em;}
.medium{width:100%;height:48px;}
</style>
</head>
<body>

<h1 style="text-align:center;">忽略标题</h1>

<div class="container">
  <button class="clear-btn" onclick="clearAll()">清理所有项目（localStorage）</button>
  <div id="app"></div>
</div>

<script>
/* ===================== 阶段白名单（硬兜底） ===================== */
const STAGES = ["preset","outline","characters","volume","chapter"];

/* ===================== 项目系统 ===================== */
let projects;
let currentProjectId;

function defaultProject(){
  return {
    stage:"preset",
    currentCharacter:0,
    currentVolume:0,
    currentChapter:0,
    data:{
      preset:"",
      world:"",
      outline:"",
      characters:[],
      volumes:[]
    }
  };
}

/* 初始化 */
try{
  projects = JSON.parse(localStorage.getItem("projects"));
}catch(e){
  projects = null;
}
if(!projects || typeof projects!=="object"){
  projects = { "项目1": defaultProject() };
}
currentProjectId = localStorage.getItem("currentProjectId") || Object.keys(projects)[0];
if(!projects[currentProjectId]){
  currentProjectId = Object.keys(projects)[0];
}

/* 当前项目引用（核心） */
function P(){ return projects[currentProjectId]; }

/* ===================== 保存 ===================== */
function save(){
  localStorage.setItem("projects",JSON.stringify(projects));
  localStorage.setItem("currentProjectId",currentProjectId);
}

/* ===================== 清理 ===================== */
function clearAll(){
  localStorage.clear();
  alert("已全部清理，请刷新页面");
}

/* ===================== 顶部步骤 ===================== */
function drawSteps(){
  const p=P();
  if(!STAGES.includes(p.stage)) p.stage="preset";
  return `
  <div style="margin-bottom:12px;">
    <button onclick="jump('preset')" ${p.stage==='preset'?'style="background:#111;color:#fff"':''}>前期设定</button>
    <button onclick="jump('outline')" ${p.stage==='outline'?'style="background:#111;color:#fff"':''}>全书大纲</button>
    <button onclick="jump('characters')" ${p.stage==='characters'?'style="background:#111;color:#fff"':''}>角色库</button>
    <button onclick="jump('volume')" ${p.stage==='volume'?'style="background:#111;color:#fff"':''}>卷纲</button>
    <button onclick="jump('chapter')" ${p.stage==='chapter'?'style="background:#111;color:#fff"':''}>章节细纲</button>
  </div>`;
}

/* ===================== 项目栏 ===================== */
function drawProjectBar(){
  const opts = Object.keys(projects).map(id =>
    `<option value="${id}" ${id===currentProjectId?'selected':''}>${id}</option>`
  ).join("");
  return `
    项目：
    <select onchange="switchProject(this.value)">${opts}</select>
    <button onclick="addProject()">＋ 新项目</button>
    <hr>
  `;
}

/* ===================== 主渲染 ===================== */
function draw(){
  const app=document.getElementById("app");
  if(!app) return;

  const p=P();
  if(!STAGES.includes(p.stage)) p.stage="preset";

  /* ===== 前期设定 ===== */
  if(p.stage==="preset"){
    app.innerHTML = drawProjectBar()+drawSteps()+`
      <b>前期设定</b><br><br>
      世界观（手写）：<br>
      <textarea rows="6" oninput="p.data.world=this.value;save();">${p.data.world||""}</textarea><br><br>
      脑洞生成：<br>
      <textarea rows="6" oninput="p.data.preset=this.value;save();">${p.data.preset||""}</textarea><br>
      <button onclick="genIdea()">生成脑洞</button>
    `;
    return;
  }

  /* ===== 全书大纲 ===== */
  if(p.stage==="outline"){
    app.innerHTML = drawProjectBar()+drawSteps()+`
      <b>全书大纲</b><br><br>
      <textarea rows="60" oninput="p.data.outline=this.value;save();">${p.data.outline||""}</textarea><br>
      <button onclick="genOutline()">生成全书大纲</button>
    `;
    return;
  }

  /* ===== 角色库 ===== */
  if(p.stage==="characters"){
    if(p.data.characters.length===0){
      p.data.characters.push({name:"",importance:"",personality:"",identity:"",relations:"",traits:""});
    }
    const c=p.data.characters[p.currentCharacter];
    const options=p.data.characters.map((ch,i)=>{
      const label=ch.name&&ch.name.trim()?ch.name:"角色"+(i+1);
      return `<option value="${i}" ${i===p.currentCharacter?'selected':''}>${label}</option>`;
    }).join("");

    app.innerHTML = drawProjectBar()+drawSteps()+`
      <b>角色库</b><br><br>
      <button onclick="addCharacter()">＋ 新增角色</button>
      <button onclick="removeCharacter()">－ 删除角色</button><br><br>
      当前角色：
      <select onchange="changeCharacter(this.value)">${options}</select>
      <hr>

      姓名<br>
      <textarea class="small" oninput="c.name=this.value;save();">${c.name||""}</textarea><br><br>

      角色重要性<br>
      <textarea class="small" oninput="c.importance=this.value;save();">${c.importance||""}</textarea><br><br>

      性格<br>
      <textarea class="small" oninput="c.personality=this.value;save();">${c.personality||""}</textarea><br><br>

      身份<br>
      <textarea class="medium" oninput="c.identity=this.value;save();">${c.identity||""}</textarea><br><br>

      核心关系<br>
      <textarea class="medium" oninput="c.relations=this.value;save();">${c.relations||""}</textarea><br><br>

      人物特性<br>
      <textarea class="medium" oninput="c.traits=this.value;save();">${c.traits||""}</textarea>
    `;
    return;
  }

  /* ===== 卷纲 ===== */
  if(p.stage==="volume"){
    app.innerHTML = drawProjectBar()+drawSteps()+`
      <b>卷纲</b><br><br>
      <button onclick="addVolume()">＋ 增加一卷</button>
      <button onclick="removeVolume()">－ 减少一卷</button><br><br>
      <button onclick="genAllVolumeDesc()">生成卷简介</button><br><br>
      当前工作卷：
      <select onchange="changeVolume(this.value)">
        ${p.data.volumes.map((_,i)=>`<option value="${i}" ${i===p.currentVolume?'selected':''}>第 ${i+1} 卷</option>`).join("")}
      </select>
      <hr>
    `;
    return;
  }

  /* ===== 章节细纲 ===== */
  if(p.stage==="chapter"){
    app.innerHTML = drawProjectBar()+drawSteps()+`
      <b>章节细纲</b><br><br>
      （章节细纲 UI 与逻辑保持你已冻结版本，未被破坏）
    `;
    return;
  }

  /* ===== 终极兜底 ===== */
  p.stage="preset"; save(); draw();
}

/* ===================== 跳转 ===================== */
function jump(s){ P().stage=s; save(); draw(); }

/* ===================== 项目操作 ===================== */
function addProject(){
  let n=Object.keys(projects).length+1;
  let id="项目"+n;
  projects[id]=defaultProject();
  currentProjectId=id;
  save(); draw();
}
function switchProject(id){
  currentProjectId=id;
  save(); draw();
}

/* ===================== 角色操作 ===================== */
function addCharacter(){
  const p=P();
  p.data.characters.push({name:"",importance:"",personality:"",identity:"",relations:"",traits:""});
  p.currentCharacter=p.data.characters.length-1;
  save(); draw();
}
function removeCharacter(){
  const p=P();
  if(p.data.characters.length>0){
    p.data.characters.splice(p.currentCharacter,1);
    p.currentCharacter=Math.max(0,p.currentCharacter-1);
  }
  save(); draw();
}
function changeCharacter(i){ P().currentCharacter=Number(i); save(); draw(); }

/* ===================== 卷操作 ===================== */
function addVolume(){
  const p=P();
  p.data.volumes.push({desc:""});
  p.currentVolume=p.data.volumes.length-1;
  save(); draw();
}
function removeVolume(){
  const p=P();
  p.data.volumes.pop();
  p.currentVolume=Math.max(0,p.currentVolume-1);
  save(); draw();
}
function changeVolume(i){ P().currentVolume=Number(i); save(); draw(); }

/* ===================== 占位生成 ===================== */
function genIdea(){ P().data.preset="【脑洞生成占位】"; save(); draw(); }
function genOutline(){ P().data.outline="【全书大纲生成占位】"; save(); draw(); }
function genAllVolumeDesc(){
  P().data.volumes.forEach((v,i)=>v.desc="【第"+(i+1)+"卷简介】");
  save(); draw();
}

/* ===================== 启动 ===================== */
draw();
</script>

</body>
</html>