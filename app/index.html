<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>忽略标题</title>
<style>
body{font-family:sans-serif;}
.container{max-width:900px;margin:0 auto;}
textarea{width:100%;box-sizing:border-box;}
button{margin:6px 6px 6px 0;}
.clear-btn{background:#f66;color:#fff;padding:6px 12px;border:none;border-radius:4px;}
.section{margin:16px 0;}
select{margin-right:8px;}
</style>
</head>
<body>

<h1 style="text-align:center;">忽略标题</h1>

<div class="container">
  <button class="clear-btn" onclick="clearData()">清理页面存储（localStorage）</button>
  <div id="app"></div>
</div>

<script>
/* ===== 初始化 ===== */
var stage = localStorage.getItem("stage") || "preset";
var currentVolume = Number(localStorage.getItem("currentVolume")) || 0;
var currentChapter = Number(localStorage.getItem("currentChapter")) || 0;
var data;

try{ data = JSON.parse(localStorage.getItem("data")); }
catch(e){ data = null; }

if(!data || typeof data!=="object"){
  data = { preset:"", world:"", outline:"", volumes:[] };
}
if(!Array.isArray(data.volumes)) data.volumes=[];

/* ===== 兜底（关键修复点） ===== */
function normalizeData(){
  if(!Array.isArray(data.volumes)) data.volumes=[];

  if(data.volumes.length===0){
    data.volumes.push({
      desc:"",
      characterArc:"",
      events:"",
      chapterCount:1,
      chapters:[{summary:"",scene:"",beats:"",text:""}]
    });
  }

  data.volumes.forEach(v=>{
    if(!Array.isArray(v.chapters) || v.chapters.length===0){
      v.chapters=[{summary:"",scene:"",beats:"",text:""}];
    }
  });

  if(currentVolume<0 || currentVolume>=data.volumes.length){
    currentVolume=0;
  }

  if(currentChapter<0 || currentChapter>=data.volumes[currentVolume].chapters.length){
    currentChapter=0;
  }
}

/* ===== 保存 ===== */
function save(){
  localStorage.setItem("stage",stage);
  localStorage.setItem("currentVolume",currentVolume);
  localStorage.setItem("currentChapter",currentChapter);
  localStorage.setItem("data",JSON.stringify(data));
}

/* ===== 清理 ===== */
function clearData(){
  localStorage.clear();
  alert("已清理，请刷新页面");
}

/* ===== 顶部步骤 ===== */
function drawSteps(){
  return `
  <div style="margin-bottom:12px;">
    <button onclick="jump('preset')">前期设定</button>
    <button onclick="jump('outline')">全书大纲</button>
    <button onclick="jump('characters')">角色库</button>
    <button onclick="jump('volume')">卷纲</button>
    <button onclick="jump('chapter')">章节细纲</button>
  </div>`;
}

/* ===== 渲染 ===== */
function draw(){
  normalizeData();
  save();

  var app=document.getElementById("app");

  if(stage==="preset"){
    app.innerHTML=drawSteps()+`
      <b>前期设定</b><br><br>
      世界观：<br>
      <textarea rows="6" oninput="data.world=this.value;save()">${data.world}</textarea><br><br>
      脑洞：<br>
      <textarea rows="6" oninput="data.preset=this.value;save()">${data.preset}</textarea>
    `;
    return;
  }

  if(stage==="outline"){
    app.innerHTML=drawSteps()+`
      <b>全书大纲</b><br><br>
      <textarea rows="12" oninput="data.outline=this.value;save()">${data.outline}</textarea>
    `;
    return;
  }

  if(stage==="characters"){
    app.innerHTML=drawSteps()+`
      <b>角色库</b><br><br>
      <p>（角色库阶段 UI 已冻结，占位）</p>
    `;
    return;
  }

  if(stage==="volume"){
    let html=drawSteps()+`<b>卷纲</b><hr>`;
    data.volumes.forEach((v,i)=>{
      html+=`
      <b>第 ${i+1} 卷</b><br>
      卷简介
      <textarea oninput="v.desc=this.value;save()">${v.desc}</textarea><br>
      主要人物弧光
      <textarea oninput="v.characterArc=this.value;save()">${v.characterArc}</textarea><br>
      事件节点
      <textarea oninput="v.events=this.value;save()">${v.events}</textarea><hr>
      `;
    });
    app.innerHTML=html;
    return;
  }

  if(stage==="chapter"){
    const v=data.volumes[currentVolume];
    const c=v.chapters[currentChapter];
    app.innerHTML=drawSteps()+`
      <b>章节细纲</b><br><br>
      章节概述
      <textarea oninput="c.summary=this.value;save()">${c.summary}</textarea><br>
      场景拆分
      <textarea oninput="c.scene=this.value;save()">${c.scene}</textarea><br>
      剧情点
      <textarea oninput="c.beats=this.value;save()">${c.beats}</textarea><br>
      正文
      <textarea style="height:300px" oninput="c.text=this.value;save()">${c.text}</textarea>
    `;
  }
}

function jump(s){ stage=s; save(); draw(); }
draw();
</script>

</body>
</html>