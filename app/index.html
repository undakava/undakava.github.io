<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>忽略标题</title>
<style>
body{font-family:sans-serif;}
.container{max-width:900px;margin:0 auto;}
textarea{box-sizing:border-box;}
button{margin:6px 6px 6px 0;}
.clear-btn{background:#f66;color:#fff;padding:6px 12px;border:none;border-radius:4px;}
.section{margin:16px 0;}
select{margin-right:8px;}

.small{
  width:20em;
  height:2.4em;
}

.medium{
  width:100%;
  height:48px;
}
</style>
</head>
<body>

<h1 style="text-align:center;">忽略标题</h1>

<div class="container">
  <button class="clear-btn" onclick="clearData()">清理页面存储（localStorage）</button>
  <div id="app"></div>
</div>

<script>
/* =========================
   项目制 · 初始化
========================= */

var projects;
var currentProjectId;

try{
  projects = JSON.parse(localStorage.getItem("projects"));
}catch(e){
  projects = null;
}

if(!projects || typeof projects!=="object"){
  currentProjectId = "project_1";
  projects = {
    project_1:{
      name:"默认小说",
      stage:"preset",
      currentCharacter:0,
      currentVolume:0,
      currentChapter:0,
      data:{
        preset:"",
        world:"",
        outline:"",
        characters:[],
        volumes:[]
      }
    }
  };
}else{
  currentProjectId = localStorage.getItem("currentProjectId") || Object.keys(projects)[0];
}

function P(){ return projects[currentProjectId]; }

/* ===== 保存 ===== */
function save(){
  localStorage.setItem("projects",JSON.stringify(projects));
  localStorage.setItem("currentProjectId",currentProjectId);
}

/* ===== 清理 ===== */
function clearData(){
  localStorage.clear();
  alert("已清理，请刷新页面");
}

/* ===== 顶部步骤 ===== */
function drawSteps(){
  var stage=P().stage;
  return `
  <div style="margin-bottom:12px;">
    <button onclick="jump('preset')" ${stage==='preset'?'style="background:#111;color:#fff"':''}>前期设定</button>
    <button onclick="jump('outline')" ${stage==='outline'?'style="background:#111;color:#fff"':''}>全书大纲</button>
    <button onclick="jump('characters')" ${stage==='characters'?'style="background:#111;color:#fff"':''}>角色库</button>
    <button onclick="jump('volume')" ${stage==='volume'?'style="background:#111;color:#fff"':''}>卷纲</button>
    <button onclick="jump('chapter')" ${stage==='chapter'?'style="background:#111;color:#fff"':''}>章节细纲</button>
  </div>`;
}

/* =========================
   渲染
========================= */
function draw(){
  var app=document.getElementById("app");
  var stage=P().stage;
  var data=P().data;

  /* ===== 前期设定 ===== */
  if(stage==="preset"){
    app.innerHTML=drawSteps()+`
      <b>前期设定</b><br><br>
      世界观（手写）：<br>
      <textarea rows="6"
        oninput="data.world=this.value;save()">${data.world||""}</textarea><br><br>
      脑洞生成：<br>
      <textarea rows="6"
        oninput="data.preset=this.value;save()">${data.preset||""}</textarea>
    `;
    return;
  }

  /* ===== 全书大纲（高度 ×5） ===== */
  if(stage==="outline"){
    app.innerHTML=drawSteps()+`
      <b>全书大纲</b><br><br>
      <textarea rows="30"
        oninput="data.outline=this.value;save()">${data.outline||""}</textarea>
    `;
    return;
  }

  /* ===== 角色库（最终定稿 UI） ===== */
  if(stage==="characters"){
    if(!Array.isArray(data.characters)) data.characters=[];
    if(data.characters.length===0){
      data.characters.push({
        name:"",importance:"",identity:"",
        personality:"",relations:"",traits:""
      });
    }

    var idx=P().currentCharacter;
    var c=data.characters[idx];

    var options=data.characters.map((ch,i)=>{
      var label=ch.name?.trim()||("角色"+(i+1));
      return `<option value="${i}" ${i===idx?'selected':''}>${label}</option>`;
    }).join("");

    app.innerHTML=drawSteps()+`
      <b>角色库</b><br><br>

      <button onclick="addCharacter()">＋ 新增角色</button>
      <button onclick="removeCharacter()">－ 删除角色</button><br><br>

      当前角色：
      <select onchange="changeCharacter(this.value)">${options}</select>
      <hr>

      姓名<br>
      <textarea class="small"
        oninput="c.name=this.value;save();draw()">${c.name||""}</textarea><br><br>

      角色重要性<br>
      <textarea class="small"
        oninput="c.importance=this.value;save()">${c.importance||""}</textarea><br><br>

      性格<br>
      <textarea class="small"
        oninput="c.personality=this.value;save()">${c.personality||""}</textarea><br><br>

      身份<br>
      <textarea class="medium"
        oninput="c.identity=this.value;save()">${c.identity||""}</textarea><br><br>

      核心关系<br>
      <textarea class="medium"
        oninput="c.relations=this.value;save()">${c.relations||""}</textarea><br><br>

      人物特性（擅长 / 弱点 / 限制）<br>
      <textarea class="medium"
        oninput="c.traits=this.value;save()">${c.traits||""}</textarea>
    `;
    return;
  }

  app.innerHTML=drawSteps()+"<p>（其余阶段保持原样）</p>";
}

/* ===== 角色库操作 ===== */
function addCharacter(){
  P().data.characters.push({
    name:"",importance:"",identity:"",
    personality:"",relations:"",traits:""
  });
  P().currentCharacter=P().data.characters.length-1;
  save(); draw();
}
function removeCharacter(){
  var d=P().data.characters;
  if(d.length>0){
    d.splice(P().currentCharacter,1);
    P().currentCharacter=Math.max(0,P().currentCharacter-1);
  }
  save(); draw();
}
function changeCharacter(i){
  P().currentCharacter=Number(i);
  save(); draw();
}

/* ===== 跳转 ===== */
function jump(s){
  P().stage=s;
  save(); draw();
}

/* ===== 启动 ===== */
draw();
</script>

</body>
</html>