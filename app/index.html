<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>小说项目管理</title>
<style>
body{font-family:sans-serif;}
.container{max-width:900px;margin:0 auto;}
textarea{width:100%;box-sizing:border-box;}
button{margin:6px 6px 6px 0;}
.clear-btn{background:#f66;color:#fff;padding:6px 12px;border:none;border-radius:4px;}
.section{margin:16px 0;}
select{margin-right:8px;}
.small{width:20em;height:2.4em;}
.medium{width:100%;height:48px;}
</style>
</head>
<body>

<h1 style="text-align:center;">小说项目管理</h1>

<div class="container">
  <button class="clear-btn" onclick="clearData()">清理页面存储（localStorage）</button><br><br>
  
  <b>项目管理</b><br>
  <input id="projectName" placeholder="输入项目名称" oninput="updateProjectName()">
  <button onclick="addProject()">＋ 新建项目</button>
  当前项目：
  <select id="projectSelect" onchange="switchProject(this.value)"></select>
  <hr>
  
  <div id="app"></div>
</div>

<script>
/* ===== 初始化 ===== */
var stage = localStorage.getItem("stage") || "preset";
var currentCharacter = 0;
var currentVolume = 0;
var currentChapter = 0;
var currentProject = 0;
var projects;

try{ projects = JSON.parse(localStorage.getItem("projects")); }
catch(e){ projects = null; }

if(!projects || !Array.isArray(projects) || projects.length===0){
  projects = [{name:"默认项目", data:{preset:"", world:"", outline:"", characters:[], volumes:[]}}];
}
var data = projects[currentProject].data;

/* ===== 保存 ===== */
function save(){
  projects[currentProject].data = data;
  localStorage.setItem("projects",JSON.stringify(projects));
  localStorage.setItem("stage",stage);
  localStorage.setItem("currentCharacter",currentCharacter);
  localStorage.setItem("currentVolume",currentVolume);
  localStorage.setItem("currentChapter",currentChapter);
  localStorage.setItem("currentProject",currentProject);
  refreshProjectSelect();
}

/* ===== 清理 ===== */
function clearData(){
  localStorage.clear();
  alert("已清理，请刷新页面");
}

/* ===== 项目管理 ===== */
function refreshProjectSelect(){
  var sel = document.getElementById("projectSelect");
  sel.innerHTML = projects.map((p,i)=>`<option value="${i}" ${i==currentProject?'selected':''}>${p.name||("项目"+(i+1))}</option>`).join("");
  document.getElementById("projectName").value = projects[currentProject].name;
}

function addProject(){
  projects.push({name:"新项目", data:{preset:"", world:"", outline:"", characters:[], volumes:[]}});
  currentProject = projects.length-1;
  data = projects[currentProject].data;
  currentCharacter=0; currentVolume=0; currentChapter=0;
  save(); draw();
}

function switchProject(i){
  saveCurrentStage(); // 保存当前阶段数据
  currentProject = Number(i);
  data = projects[currentProject].data;
  currentCharacter=0; currentVolume=0; currentChapter=0;
  save(); draw();
}

function updateProjectName(){
  projects[currentProject].name = document.getElementById("projectName").value;
  save();
}

/* ===== 保存当前阶段内容 ===== */
function saveCurrentStage(){
  if(stage==="preset"){
    data.world = document.getElementById("world")?.value||"";
    data.preset = document.getElementById("main")?.value||"";
  } else if(stage==="outline"){
    data.outline = document.getElementById("main")?.value||"";
  }
}

/* ===== 顶部步骤 ===== */
function drawSteps(){
  return `
  <div style="margin-bottom:12px;">
    <button onclick="jump('preset')" ${stage==='preset'?'style="background:#111;color:#fff"':''}>前期设定</button>
    <button onclick="jump('outline')" ${stage==='outline'?'style="background:#111;color:#fff"':''}>全书大纲</button>
    <button onclick="jump('characters')" ${stage==='characters'?'style="background:#111;color:#fff"':''}>角色库</button>
    <button onclick="jump('volume')" ${stage==='volume'?'style="background:#111;color:#fff"':''}>卷纲</button>
    <button onclick="jump('chapter')" ${stage==='chapter'?'style="background:#111;color:#fff"':''}>章节细纲</button>
  </div>`;
}

/* ===== 渲染 ===== */
function draw(){
  refreshProjectSelect();
  saveCurrentStage();
  var app=document.getElementById("app");
  if(!app) return;

  /* ===== 前期设定 ===== */
  if(stage==="preset"){
    app.innerHTML=drawSteps()+`
      <b>前期设定</b><br><br>
      世界观（手写）：<br>
      <textarea id="world" rows="6" oninput="save()">${data.world||""}</textarea><br><br>
      脑洞生成：<br>
      <textarea id="main" rows="6" oninput="save()">${data.preset||""}</textarea><br>
      <button onclick="genIdea()">生成脑洞</button>
    `;
    return;
  }

  /* ===== 全书大纲 ===== */
  if(stage==="outline"){
    app.innerHTML=drawSteps()+`
      <b>全书大纲</b><br><br>
      <textarea id="main" rows="60" oninput="save()">${data.outline||""}</textarea><br>
      <button onclick="genOutline()">生成全书大纲</button>
    `;
    return;
  }

  /* ===== 角色库 ===== */
  if(stage==="characters"){
    if(data.characters.length===0){
      data.characters.push({name:"",importance:"",identity:"",personality:"",relations:"",traits:""});
      currentCharacter=0;
    }
    var c = data.characters[currentCharacter];
    var options = data.characters.map((ch,i)=>{
      var label = ch.name && ch.name.trim() ? ch.name.trim() : "角色" + (i+1);
      return `<option value="${i}" ${i===currentCharacter?'selected':''}>${label}</option>`;
    }).join("");

    app.innerHTML = drawSteps()+`
      <b>角色库</b><br><br>
      <button onclick="addCharacter()">＋ 新增角色</button>
      <button onclick="removeCharacter()">－ 删除角色</button><br><br>
      当前角色：
      <select onchange="changeCharacter(this.value)">${options}</select>
      <hr>
      姓名<br>
      <textarea class="small" id="char_name" oninput="updateCurrentCharacter('name')">${c.name||""}</textarea><br><br>
      角色重要性<br>
      <textarea class="small" id="char_importance" oninput="updateCurrentCharacter('importance')">${c.importance||""}</textarea><br><br>
      性格<br>
      <textarea class="small" id="char_personality" oninput="updateCurrentCharacter('personality')">${c.personality||""}</textarea><br><br>
      身份<br>
      <textarea class="medium" id="char_identity" oninput="updateCurrentCharacter('identity')">${c.identity||""}</textarea><br><br>
      核心关系<br>
      <textarea class="medium" id="char_relations" oninput="updateCurrentCharacter('relations')">${c.relations||""}</textarea><br><br>
      人物特性（擅长 / 弱点 / 限制）<br>
      <textarea class="medium" id="char_traits" oninput="updateCurrentCharacter('traits')">${c.traits||""}</textarea>
    `;
    return;
  }

  /* ===== 卷纲 & 章节细纲略（同完美版UI） ===== */
  // 为简短示例，卷纲和章节细纲保留原本UI逻辑，只需保证调用 save() 和 updateVolumeField() 正确
}

/* ===== 角色库操作 ===== */
function updateCurrentCharacter(field){
  data.characters[currentCharacter][field] = document.getElementById("char_"+field).value;
  save(); draw();
}

function addCharacter(){
  data.characters.push({name:"",importance:"",identity:"",personality:"",relations:"",traits:""});
  currentCharacter = data.characters.length-1;
  save(); draw();
}

function removeCharacter(){
  if(data.characters.length>0){
    data.characters.splice(currentCharacter,1);
    currentCharacter = Math.max(0,currentCharacter-1);
    save(); draw();
  }
}

function changeCharacter(i){
  updateCurrentCharacterAll(); // 保存当前角色
  currentCharacter = Number(i);
  save(); draw();
}

function updateCurrentCharacterAll(){
  if(data.characters[currentCharacter]){
    data.characters[currentCharacter].name = document.getElementById("char_name")?.value||"";
    data.characters[currentCharacter].importance = document.getElementById("char_importance")?.value||"";
    data.characters[currentCharacter].personality = document.getElementById("char_personality")?.value||"";
    data.characters[currentCharacter].identity = document.getElementById("char_identity")?.value||"";
    data.characters[currentCharacter].relations = document.getElementById("char_relations")?.value||"";
    data.characters[currentCharacter].traits = document.getElementById("char_traits")?.value||"";
  }
}

/* ===== 跳转阶段 ===== */
function jump(s){ saveCurrentStage(); stage=s; draw(); }

/* ===== 占位生成 ===== */
function genIdea(){ data.preset="【脑洞生成占位】"; save(); draw(); }
function genOutline(){ data.outline="【全书大纲生成占位】"; save(); draw(); }

/* ===== 启动 ===== */
draw();
</script>

</body>
</html>