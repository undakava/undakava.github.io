<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>酒亂黨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 16px;
    }
    h1 {
      text-align: center;
    }
    textarea {
      width: 100%;
      min-height: 120px;
      box-sizing: border-box;
      margin-bottom: 8px;
    }
    select, button {
      margin: 4px 0;
    }
    .stage {
      border: 1px solid #ccc;
      padding: 12px;
      margin-bottom: 16px;
    }
    .top-bar {
      margin-bottom: 16px;
      text-align: right;
    }
  </style>
</head>
<body>

<h1>酒亂黨</h1>

<!-- 【补丁 2】顶部清除 localStorage 按键（安全阀，永久存在） -->
<div class="top-bar">
  <button id="clearStorageBtn">清除 localStorage</button>
</div>

<!-- ================= A 阶段：前期设定 ================= -->
<!-- 【补丁 1】严格恢复原始结构：世界观手写 + 脑洞生成 + 单一按钮 -->
<div class="stage" id="stage-a">
  <h2>前期设定</h2>

  <!-- 世界观：纯手写 -->
  <label>世界观设定（手写）：</label>
  <textarea id="worldviewInput"></textarea>

  <!-- 脑洞：生成展示 -->
  <label>脑洞生成：</label>
  <textarea id="ideaOutput" readonly></textarea>

  <!-- 唯一按钮 -->
  <button id="generateIdeaBtn">生成脑洞</button>
</div>

<!-- ================= 卷 / 章节选择（既有结构，不重构） ================= -->
<div class="stage" id="stage-chapter">
  <h2>章节细纲</h2>

  <label>选择卷：</label><br>
  <select id="volumeSelect"></select><br>

  <label>选择章节：</label><br>
  <select id="chapterSelect"></select><br>

  <label>章节概述：</label>
  <textarea id="chapterSummary"></textarea>

  <label>章节剧情点：</label>
  <textarea id="chapterOutline"></textarea>
</div>

<script>
/* ======================== 基础工具 ======================== */

function getData() {
  try {
    return JSON.parse(localStorage.getItem('data')) || null;
  } catch {
    return null;
  }
}

function saveData(data) {
  localStorage.setItem('data', JSON.stringify(data));
}

/* ======================== 初始化兜底 ======================== */

function initDataIfNeeded() {
  let data = getData();
  if (!data) {
    data = {
      volumes: [
        {
          chapters: [
            { summary: '', outline: '' }
          ]
        }
      ]
    };
    saveData(data);
  }
  return data;
}

/* ======================== A 阶段逻辑（不联动） ======================== */

document.getElementById('generateIdeaBtn').onclick = function () {
  document.getElementById('ideaOutput').value = '（此处生成脑洞示例文本）';
};

/* ======================== 下拉框逻辑 ======================== */

function renderVolumeSelect(data) {
  const volSel = document.getElementById('volumeSelect');
  volSel.innerHTML = '';
  data.volumes.forEach((_, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = `第 ${i + 1} 卷`;
    volSel.appendChild(opt);
  });
}

function renderChapterSelect(data, volIndex) {
  const chapSel = document.getElementById('chapterSelect');
  chapSel.innerHTML = '';
  data.volumes[volIndex].chapters.forEach((_, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = `第 ${i + 1} 章`;
    chapSel.appendChild(opt);
  });
}

/* ======================== 【补丁 3】关键修复点 ======================== */
/* 无论卷是否变化，进入页面时强制初始化章节下拉框 */

function forceInitChapterSelect() {
  const data = initDataIfNeeded();
  renderVolumeSelect(data);
  renderChapterSelect(data, 0); // 强制初始化
}

document.getElementById('volumeSelect').onchange = function () {
  const data = initDataIfNeeded();
  renderChapterSelect(data, Number(this.value));
};

/* ======================== 清除 localStorage ======================== */

document.getElementById('clearStorageBtn').onclick = function () {
  localStorage.clear();
  location.reload();
};

/* ======================== 页面启动 ======================== */

forceInitChapterSelect();
</script>

</body>
</html>