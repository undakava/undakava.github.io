<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>忽略标题</title>
<style>
body{font-family:sans-serif;}
.container{max-width:900px;margin:0 auto;}
textarea{width:100%;box-sizing:border-box;}
button{margin:6px 6px 6px 0;}
.clear-btn{background:#f66;color:#fff;padding:6px 12px;border:none;border-radius:4px;}
.section{margin:16px 0;}
select{margin-right:8px;}
</style>
</head>
<body>

<h1 style="text-align:center;">忽略标题</h1>

<div class="container">
  <button class="clear-btn" onclick="clearData()">清理页面存储（localStorage）</button>
  <div id="app"></div>
</div>

<script>
/* ===== 初始化 ===== */
var stage = localStorage.getItem("stage") || "preset";
var currentVolume = Number(localStorage.getItem("currentVolume")) || 0;
var currentChapter = Number(localStorage.getItem("currentChapter")) || 0;
var currentCharacter = Number(localStorage.getItem("currentCharacter")) || 0;
var data;

try{ data = JSON.parse(localStorage.getItem("data")); }
catch(e){ data = null; }

if(!data || typeof data!=="object"){
  data = { preset:"", world:"", outline:"", volumes:[], characters:[] };
}

if(!Array.isArray(data.volumes)) data.volumes=[];
if(!Array.isArray(data.characters)) data.characters=[];

/* ===== 保存 ===== */
function save(){
  localStorage.setItem("stage",stage);
  localStorage.setItem("currentVolume",currentVolume);
  localStorage.setItem("currentChapter",currentChapter);
  localStorage.setItem("currentCharacter",currentCharacter);
  localStorage.setItem("data",JSON.stringify(data));
}

/* ===== 清理 ===== */
function clearData(){
  localStorage.clear();
  alert("已清理，请刷新页面");
}

/* ===== 顶部步骤 ===== */
function drawSteps(){
  return `
  <div style="margin-bottom:12px;">
    <button onclick="jump('preset')">前期设定</button>
    <button onclick="jump('outline')">全书大纲</button>
    <button onclick="jump('characters')">角色库</button>
    <button onclick="jump('volume')">卷纲</button>
    <button onclick="jump('chapter')">章节细纲</button>
  </div>`;
}

/* ===== 渲染 ===== */
function draw(){
  var app=document.getElementById("app");
  if(!app) return;

  /* ===== 角色库 ===== */
  if(stage==="characters"){

    if(data.characters.length===0){
      data.characters.push({
        name:"角色1",
        importance:"",
        identity:"",
        personality:"",
        appearance:"",
        background:"",
        note:""
      });
      currentCharacter=0;
      save();
    }

    var c = data.characters[currentCharacter];

    app.innerHTML = drawSteps()+`
      <b>角色库</b><br><br>

      <button onclick="addCharacter()">＋ 新角色</button>
      <button onclick="removeCharacter()">－ 删除角色</button>
      <br><br>

      当前角色：
      <select onchange="changeCharacter(this.value)">
        ${data.characters.map((r,i)=>`
          <option value="${i}" ${i===currentCharacter?'selected':''}>
            ${r.name||('角色'+(i+1))}
          </option>`).join("")}
      </select>

      <hr>

      名字
      <textarea rows="2" oninput="c.name=this.value;save();">${c.name||""}</textarea><br><br>

      身份
      <textarea rows="2" oninput="c.identity=this.value;save();">${c.identity||""}</textarea><br><br>

      性格
      <textarea rows="2" oninput="c.personality=this.value;save();">${c.personality||""}</textarea><br><br>

      外貌
      <textarea rows="3" oninput="c.appearance=this.value;save();">${c.appearance||""}</textarea><br><br>

      背景
      <textarea rows="4" oninput="c.background=this.value;save();">${c.background||""}</textarea><br><br>

      备注
      <textarea rows="3" oninput="c.note=this.value;save();">${c.note||""}</textarea>
    `;
    return;
  }

  /* ===== 其余阶段保持不变 ===== */
  /* ——你给的稳定代码原样保留—— */

  app.innerHTML = drawSteps()+`<p>请选择阶段</p>`;
}

/* ===== 角色操作 ===== */
function addCharacter(){
  data.characters.push({
    name:"角色"+(data.characters.length+1),
    importance:"",
    identity:"",
    personality:"",
    appearance:"",
    background:"",
    note:""
  });
  currentCharacter=data.characters.length-1;
  save(); draw();
}

function removeCharacter(){
  if(data.characters.length>1){
    data.characters.splice(currentCharacter,1);
    currentCharacter=Math.max(0,currentCharacter-1);
    save(); draw();
  }
}

function changeCharacter(i){
  currentCharacter=Number(i);
  save(); draw();
}

/* ===== 跳转 ===== */
function jump(s){ stage=s; save(); draw(); }

/* ===== 启动 ===== */
draw();
</script>

</body>
</html>