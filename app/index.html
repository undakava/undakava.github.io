<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>创作工具</title>

<style>
body{font-family:sans-serif;}
.container{max-width:900px;margin:0 auto;}
textarea{width:100%;box-sizing:border-box;}
button{margin:6px 6px 6px 0;}
.clear-btn{background:#f66;color:#fff;padding:6px 12px;border:none;border-radius:4px;}
.section{margin:16px 0;}
select{margin-right:8px;}
.small{width:20em;height:2.4em;}
.medium{width:100%;height:48px;}
</style>
</head>

<body>
<h1 style="text-align:center;">创作工具</h1>

<div class="container">
<button class="clear-btn" onclick="clearData()">清理页面存储</button>
<div id="app"></div>
</div>

<script>

/* ===== 初始化 ===== */

var stage = localStorage.getItem("stage") || "preset";
var currentProject = Number(localStorage.getItem("currentProject")) || 0;
var currentCharacter = Number(localStorage.getItem("currentCharacter")) || 0;
var currentVolume = Number(localStorage.getItem("currentVolume")) || 0;
var currentChapter = Number(localStorage.getItem("currentChapter")) || 0;

var data = JSON.parse(localStorage.getItem("data") || '{"projects":[]}');

if(!data.projects.length){
data.projects.push({
name:"新项目",
preset:"",
world:"",
outline:"",
characters:[],
volumes:[]
});
}

/* ===== 保存 ===== */
function save(){
localStorage.setItem("stage",stage);
localStorage.setItem("currentProject",currentProject);
localStorage.setItem("currentCharacter",currentCharacter);
localStorage.setItem("currentVolume",currentVolume);
localStorage.setItem("currentChapter",currentChapter);
localStorage.setItem("data",JSON.stringify(data));
}

function clearData(){
localStorage.clear();
location.reload();
}

/* ===== 顶部栏 ===== */
function drawProjectBar(){

var p=data.projects[currentProject];

var options=data.projects.map((x,i)=>
`<option value="${i}" ${i===currentProject?'selected':''}>${x.name||"未命名"}</option>`
).join("");

return `
项目：
<select onchange="changeProject(this.value)">${options}</select>

名称：
<textarea class="small"
oninput="data.projects[currentProject].name=this.value;save();"
>${p.name||""}</textarea>

<button onclick="addProject()">新建项目</button>
<button onclick="removeProject()">删除项目</button>
<hr>
`;
}

function drawSteps(){
return `
<button onclick="jump('preset')">前期设定</button>
<button onclick="jump('outline')">全书大纲</button>
<button onclick="jump('characters')">角色库</button>
<button onclick="jump('volume')">卷纲</button>
<button onclick="jump('chapter')">章节细纲</button>
<hr>
`;
}

/* ===== 渲染 ===== */
function draw(){

var app=document.getElementById("app");
var p=data.projects[currentProject];

/* ===== 前期 ===== */
if(stage==="preset"){
app.innerHTML=drawProjectBar()+drawSteps()+`
世界观<br>
<textarea rows="6"
oninput="p.world=this.value;save();"
>${p.world||""}</textarea><br><br>

脑洞<br>
<textarea rows="6"
oninput="p.preset=this.value;save();"
>${p.preset||""}</textarea><br>

<button onclick="p.preset='【脑洞生成占位】';save();draw();">生成脑洞</button>
`;
return;
}

/* ===== 大纲 ===== */
if(stage==="outline"){
app.innerHTML=drawProjectBar()+drawSteps()+`
<textarea rows="48"
oninput="p.outline=this.value;save();"
>${p.outline||""}</textarea><br>

<button onclick="p.outline='【大纲生成占位】';save();draw();">生成全书大纲</button>
`;
return;
}

/* ===== 角色库 ===== */
if(stage==="characters"){

if(!p.characters.length){
p.characters.push({name:"",importance:"",identity:"",personality:"",relations:"",traits:""});
}

var c=p.characters[currentCharacter];

var options=p.characters.map((ch,i)=>{
var label=ch.name&&ch.name.trim()?ch.name.trim():"角色"+(i+1);
return `<option value="${i}" ${i===currentCharacter?'selected':''}>${label}</option>`;
}).join("");

app.innerHTML=drawProjectBar()+drawSteps()+`

<button onclick="addCharacter()">新增角色</button>
<button onclick="removeCharacter()">删除角色</button><br><br>

<select onchange="changeCharacter(this.value)">${options}</select>
<hr>

姓名<textarea class="small" oninput="c.name=this.value;save();">${c.name||""}</textarea>
角色重要性<textarea class="small" oninput="c.importance=this.value;save();">${c.importance||""}</textarea>
性格<textarea class="small" oninput="c.personality=this.value;save();">${c.personality||""}</textarea>
身份<textarea class="medium" oninput="c.identity=this.value;save();">${c.identity||""}</textarea>
核心关系<textarea class="medium" oninput="c.relations=this.value;save();">${c.relations||""}</textarea>
人物特性<textarea class="medium" oninput="c.traits=this.value;save();">${c.traits||""}</textarea>
`;
return;
}

/* ===== 卷纲 ===== */

if(stage==="volume"){

var html=drawProjectBar()+drawSteps()+`
<button onclick="addVolume()">＋增加一卷</button>
<button onclick="removeVolume()">－减少一卷</button>
<button onclick="genAllVolumeDesc()">生成卷简介</button>
<br><br>

当前工作卷：
<select onchange="changeVolume(this.value)">
${p.volumes.map((_,i)=>`<option value="${i}" ${i===currentVolume?'selected':''}>第${i+1}卷</option>`).join("")}
</select>
<hr>
`;

var v=p.volumes[currentVolume];
if(!v){ app.innerHTML=html+"请先创建卷"; return; }

html+=`
卷简介
<textarea style="height:120px"
oninput="v.desc=this.value;save();">${v.desc||""}</textarea>

主要人物弧光
<textarea style="height:90px"
oninput="v.characterArc=this.value;save();">${v.characterArc||""}</textarea>

卷初状态
<textarea style="height:70px"
oninput="v.startState=this.value;save();">${v.startState||""}</textarea>

<button onclick="v.goal='【目标计划占位】';save();draw();">生成目标计划</button>

卷目标
<textarea style="height:70px"
oninput="v.goal=this.value;save();">${v.goal||""}</textarea>

<button onclick="v.events='【事件节点占位】';save();draw();">生成事件节点</button>

事件节点
<textarea style="height:110px"
oninput="v.events=this.value;save();">${v.events||""}</textarea>

卷末状态
<textarea style="height:70px"
oninput="v.endState=this.value;save();">${v.endState||""}</textarea>

章节数：
<input type="number" min="1" value="${v.chapterCount||1}"
onchange="v.chapterCount=this.value;save();">

<button onclick="genChapterOutline()">生成章节概述</button>
`;

app.innerHTML=html;
return;
}

/* ===== 章节细纲 ===== */

if(stage==="chapter"){

if(!p.volumes.length){
app.innerHTML=drawProjectBar()+drawSteps()+"请先创建卷";
return;
}

var v=p.volumes[currentVolume];
if(!v.chapters||!v.chapters.length){
v.chapters=[{summary:"",scene:"",beats:"",text:""}];
}

var c=v.chapters[currentChapter];

var volOptions=p.volumes.map((_,i)=>
`<option value="${i}" ${i===currentVolume?'selected':''}>第${i+1}卷</option>`
).join("");

var chapOptions=v.chapters.map((_,i)=>
`<option value="${i}" ${i===currentChapter?'selected':''}>第${i+1}章</option>`
).join("");

app.innerHTML=drawProjectBar()+drawSteps()+`

第 <select onchange="changeVolume(this.value)">${volOptions}</select> 卷
第 <select onchange="changeChapter(this.value)">${chapOptions}</select> 章

章节概述
<textarea rows="4" oninput="c.summary=this.value;save();">${c.summary||""}</textarea>

<button onclick="if(!c.scene)c.scene='【场景拆分占位】';save();draw();">场景拆分</button>

场景<textarea rows="4" oninput="c.scene=this.value;save();">${c.scene||""}</textarea>

<button onclick="if(!c.beats)c.beats='【剧情点占位】';save();draw();">生成剧情点</button>

剧情点<textarea rows="6" oninput="c.beats=this.value;save();">${c.beats||""}</textarea>

<button onclick="if(!c.text)c.text='【正文占位】';save();draw();">生成正文</button>

正文<textarea style="height:600px" oninput="c.text=this.value;save();">${c.text||""}</textarea>
`;

return;
}

}

/* ===== 操作 ===== */

function jump(s){stage=s;save();draw();}

function addProject(){
data.projects.push({name:"新项目",preset:"",world:"",outline:"",characters:[],volumes:[]});
currentProject=data.projects.length-1;
save();draw();
}
function removeProject(){
if(data.projects.length>1){
data.projects.splice(currentProject,1);
currentProject=0;
save();draw();
}
}
function changeProject(i){
currentProject=Number(i);
currentCharacter=0;
currentVolume=0;
currentChapter=0;
save();draw();
}

function addCharacter(){
data.projects[currentProject].characters.push({});
currentCharacter=data.projects[currentProject].characters.length-1;
save();draw();
}
function removeCharacter(){
var arr=data.projects[currentProject].characters;
if(arr.length){arr.splice(currentCharacter,1);currentCharacter=0;}
save();draw();
}
function changeCharacter(i){currentCharacter=Number(i);save();draw();}

function addVolume(){
data.projects[currentProject].volumes.push({chapterCount:1,chapters:[]});
currentVolume=data.projects[currentProject].volumes.length-1;
save();draw();
}
function removeVolume(){
var arr=data.projects[currentProject].volumes;
if(arr.length){arr.pop();currentVolume=0;}
save();draw();
}
function changeVolume(i){currentVolume=Number(i);currentChapter=0;save();draw();}
function changeChapter(i){currentChapter=Number(i);save();draw();}

function genAllVolumeDesc(){
var p=data.projects[currentProject];
p.volumes.forEach((v,i)=>v.desc="【第"+(i+1)+"卷简介】\n"+(p.outline||""));
save();draw();
}

function genChapterOutline(){
var v=data.projects[currentProject].volumes[currentVolume];
v.chapters=[];
for(let i=0;i<(v.chapterCount||1);i++){
v.chapters.push({summary:"第"+(i+1)+"章概述"});
}
save();draw();
}

/* ===== 启动 ===== */
draw();

</script>
</body>
</html>