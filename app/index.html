<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>项目制写作工具</title>
<style>
body{font-family:sans-serif;}
.container{max-width:900px;margin:0 auto;}
textarea{width:100%;box-sizing:border-box;}
button{margin:6px 6px 6px 0;}
.clear-btn{background:#f66;color:#fff;padding:6px 12px;border:none;border-radius:4px;}
.section{margin:16px 0;}
select{margin-right:8px;}
.small{width:20em;height:2.4em;}
.medium{width:100%;height:48px;}
</style>
</head>
<body>

<h1 style="text-align:center;">项目制写作工具</h1>

<div class="container">
  <button class="clear-btn" onclick="clearData()">清理页面存储（localStorage）</button>
  <div id="app"></div>
</div>

<script>
/* ===== 初始化 ===== */
var stage = localStorage.getItem("stage") || "preset";
var currentProject = Number(localStorage.getItem("currentProject")) || 0;
var currentCharacter = 0;
var currentVolume = 0;
var currentChapter = 0;

var projects;

try{ projects = JSON.parse(localStorage.getItem("projects")); }
catch(e){ projects = null; }

if(!projects || !Array.isArray(projects)){ projects=[{name:"默认项目",world:"",preset:"",outline:"",characters:[],volumes:[]}]; }

function currentData(){ return projects[currentProject]; }

/* ===== 保存 ===== */
function saveAll(){
  localStorage.setItem("stage",stage);
  localStorage.setItem("currentProject",currentProject);
  localStorage.setItem("projects",JSON.stringify(projects));
}

/* ===== 清理 ===== */
function clearData(){
  localStorage.clear();
  alert("已清理，请刷新页面");
}

/* ===== 顶部步骤 ===== */
function drawSteps(){
  return `
  <div style="margin-bottom:12px;">
    <button onclick="jump('preset')" ${stage==='preset'?'style="background:#111;color:#fff"':''}>前期设定</button>
    <button onclick="jump('outline')" ${stage==='outline'?'style="background:#111;color:#fff"':''}>全书大纲</button>
    <button onclick="jump('characters')" ${stage==='characters'?'style="background:#111;color:#fff"':''}>角色库</button>
    <button onclick="jump('volume')" ${stage==='volume'?'style="background:#111;color:#fff"':''}>卷纲</button>
    <button onclick="jump('chapter')" ${stage==='chapter'?'style="background:#111;color:#fff"':''}>章节细纲</button>
  </div>`;
}

/* ===== 渲染 ===== */
function draw(){
  var app=document.getElementById("app");
  if(!app) return;
  var data=currentData();

  // 保存正在编辑的内容，避免跳转丢失
  var ta_ids = ["world","preset","outline"];
  ta_ids.forEach(id=>{
    var ta=document.getElementById(id);
    if(ta) data[id]=ta.value;
  });

  if(stage==="characters" && data.characters.length>0){
    var c=data.characters[currentCharacter];
    ["name","importance","identity","personality","relations","traits"].forEach(k=>{
      var ta=document.getElementById("char_"+k);
      if(ta) c[k]=ta.value;
    });
  }

  if(stage==="volume" && data.volumes.length>0){
    var v=data.volumes[currentVolume];
    ["desc","characterArc","startState","goal","events","endState"].forEach(k=>{
      var ta=document.getElementById("vol_"+k);
      if(ta) v[k]=ta.value;
    });
    var chapCountInput=document.getElementById("vol_chapterCount");
    if(chapCountInput) v.chapterCount=Number(chapCountInput.value)||1;
  }

  if(stage==="chapter" && data.volumes.length>0){
    var v=data.volumes[currentVolume];
    if(v.chapters && v.chapters.length>0){
      var c=v.chapters[currentChapter];
      ["summary","scene","beats","text"].forEach(k=>{
        var ta=document.getElementById("chap_"+k);
        if(ta) c[k]=ta.value;
      });
    }
  }

  saveAll();

  // ---------- 渲染内容 ----------

  // 前期设定
  if(stage==="preset"){
    app.innerHTML=drawSteps()+`
      <b>项目名</b><br>
      <input type="text" style="width:50%" value="${data.name}" onchange="data.name=this.value;saveAll();"><br><br>

      <b>世界观</b><br>
      <textarea id="world" rows="6">${data.world||""}</textarea><br><br>

      <b>脑洞生成</b><br>
      <textarea id="preset" rows="6">${data.preset||""}</textarea><br>
      <button onclick="genIdea()">生成脑洞</button>
    `;
    return;
  }

  // 全书大纲
  if(stage==="outline"){
    app.innerHTML=drawSteps()+`
      <b>全书大纲</b><br>
      <textarea id="outline" rows="60">${data.outline||""}</textarea><br>
      <button onclick="genOutline()">生成全书大纲</button>
    `;
    return;
  }

  // 角色库
  if(stage==="characters"){
    if(data.characters.length===0) data.characters.push({name:"",importance:"",identity:"",personality:"",relations:"",traits:""});
    var c = data.characters[currentCharacter];
    var options = data.characters.map((ch,i)=>{
      var label=ch.name.trim()?ch.name.trim():"角色"+(i+1);
      return `<option value="${i}" ${i===currentCharacter?'selected':''}>${label}</option>`;
    }).join("");
    app.innerHTML=drawSteps()+`
      <b>角色库</b><br>
      <button onclick="addCharacter()">＋ 新增角色</button>
      <button onclick="removeCharacter()">－ 删除角色</button><br><br>
      当前角色：
      <select onchange="changeCharacter(this.value)">${options}</select>
      <hr>

      姓名<br><textarea id="char_name" class="small">${c.name||""}</textarea><br><br>
      角色重要性<br><textarea id="char_importance" class="small">${c.importance||""}</textarea><br><br>
      性格<br><textarea id="char_personality" class="small">${c.personality||""}</textarea><br><br>
      身份<br><textarea id="char_identity" class="medium">${c.identity||""}</textarea><br><br>
      核心关系<br><textarea id="char_relations" class="medium">${c.relations||""}</textarea><br><br>
      人物特性（擅长 / 弱点 / 限制）<br><textarea id="char_traits" class="medium">${c.traits||""}</textarea>
    `;
    return;
  }

  // 卷纲
  if(stage==="volume"){
    if(data.volumes.length===0) data.volumes.push({desc:"",characterArc:"",startState:"",goal:"",events:"",endState:"",chapterCount:1,chapters:[{summary:"",scene:"",beats:"",text:""}]});
    var v = data.volumes[currentVolume];
    app.innerHTML=drawSteps()+`
      <b>卷纲</b><br>
      <button onclick="addVolume()">＋ 增加一卷</button>
      <button onclick="removeVolume()">－ 删除一卷</button><br><br>

      当前工作卷：
      <select onchange="changeVolume(this.value)">
        ${data.volumes.map((_,i)=>`<option value="${i}" ${i===currentVolume?'selected':''}>第 ${i+1} 卷</option>`).join("")}
      </select><hr>

      卷简介<br><textarea id="vol_desc" style="height:120px">${v.desc||""}</textarea><br>
      主要人物弧光<br><textarea id="vol_characterArc" style="height:90px">${v.characterArc||""}</textarea><br>
      卷初状态<br><textarea id="vol_startState" style="height:70px">${v.startState||""}</textarea><br>
      卷初目标计划<br><textarea id="vol_goal" style="height:70px">${v.goal||""}</textarea><br>
      事件节点<br><textarea id="vol_events" style="height:110px">${v.events||""}</textarea><br>
      卷末状态结算<br><textarea id="vol_endState" style="height:70px">${v.endState||""}</textarea><br>
      章节数：<input type="number" min="1" id="vol_chapterCount" value="${v.chapterCount||1}"><br>
    `;
    return;
  }

  // 章节细纲
  if(stage==="chapter"){
    if(data.volumes.length===0){ draw(); return; }
    var v = data.volumes[currentVolume];
    if(!v.chapters || v.chapters.length===0) v.chapters=[{summary:"",scene:"",beats:"",text:""}];
    var c = v.chapters[currentChapter];
    app.innerHTML=drawSteps()+`
      <b>章节细纲</b><br>
      第<select onchange="changeVolume(this.value)">${data.volumes.map((_,i)=>`<option value="${i}" ${i===currentVolume?'selected':''}>${i+1}</option>`).join("")}</select>卷　
      第<select onchange="changeChapter(this.value)">${v.chapters.map((_,i)=>`<option value="${i}" ${i===currentChapter?'selected':''}>${i+1}</option>`).join("")}</select>章<br><br>

      概述<br><textarea id="chap_summary" rows="4">${c.summary||""}</textarea><br>
      场景拆分<br><textarea id="chap_scene" rows="4">${c.scene||""}</textarea><br>
      剧情点<br><textarea id="chap_beats" rows="6">${c.beats||""}</textarea><br>
      正文<br><textarea id="chap_text" style="height:600px">${c.text||""}</textarea>
    `;
}

/* ===== 跳转 ===== */
function jump(s){ stage=s; saveAll(); draw(); }

/* ===== 占位生成 ===== */
function genIdea(){ currentData().preset="【脑洞生成占位】"; saveAll(); draw(); }
function genOutline(){ currentData().outline="【全书大纲占位】"; saveAll(); draw(); }

/* ===== 角色库操作 ===== */
function addCharacter(){ currentData().characters.push({name:"",importance:"",identity:"",personality:"",relations:"",traits:""}); currentCharacter=currentData().characters.length-1; saveAll(); draw(); }
function removeCharacter(){ var arr=currentData().characters; if(arr.length>0){ arr.splice(currentCharacter,1); currentCharacter=Math.max(0,currentCharacter-1); saveAll(); draw(); } }
function changeCharacter(i){ saveAll(); currentCharacter=Number(i); draw(); }

/* ===== 项目制操作 ===== */
function addProject(){ projects.push({name:"新项目",world:"",preset:"",outline:"",characters:[],volumes:[]}); currentProject=projects.length-1; saveAll(); draw(); }
function changeProject(i){ currentProject=Number(i); saveAll(); draw(); }

/* ===== 卷纲章节切换（占位功能可继续扩展） ===== */
function addVolume(){ currentData().volumes.push({desc:"",characterArc:"",startState:"",goal:"",events:"",endState:"",chapterCount:1,chapters:[{summary:"",scene:"",beats:"",text:""}]}); currentVolume=currentData().volumes.length-1; saveAll(); draw(); }
function removeVolume(){ var vols=currentData().volumes; if(vols.length>0){ vols.pop(); currentVolume=Math.max(0,currentVolume-1); saveAll(); draw(); } }
function changeVolume(i){ currentVolume=Number(i); currentChapter=0; saveAll(); draw(); }
function changeChapter(i){ currentChapter=Number(i); saveAll(); draw(); }

/* ===== 启动 ===== */
draw();
</script>
</body>
</html>