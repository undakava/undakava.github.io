<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>忽略标题</title>
<style>
body{font-family:sans-serif;}
.container{max-width:900px;margin:0 auto;}
textarea{width:100%;box-sizing:border-box;}
button{margin:6px 6px 6px 0;}
.clear-btn{background:#f66;color:#fff;padding:6px 12px;border:none;border-radius:4px;}
.section{margin:16px 0;}
select{margin-right:8px;}
.small{width:20em;height:2.4em;}
.medium{width:100%;height:48px;}
</style>
</head>
<body>

<h1 style="text-align:center;">忽略标题</h1>

<div class="container">
  <button class="clear-btn" onclick="clearAll()">清理全部存储（慎用）</button>
  <div id="app"></div>
</div>

<script>
/* ================= 项目制初始化 ================= */

var projects = {};
var currentProject = localStorage.getItem("currentProject") || "默认项目";

try{
  projects = JSON.parse(localStorage.getItem("novel_projects")) || {};
}catch(e){
  projects = {};
}

if(!projects[currentProject]){
  projects[currentProject] = createEmptyProject();
}

function createEmptyProject(){
  return {
    stage:"preset",
    currentCharacter:0,
    currentVolume:0,
    currentChapter:0,
    data:{
      preset:"",
      world:"",
      outline:"",
      characters:[],
      volumes:[]
    }
  };
}

/* ================= 项目级状态指针 ================= */

var stage, currentCharacter, currentVolume, currentChapter, data;

function loadProject(){
  var p = projects[currentProject];
  stage = p.stage;
  currentCharacter = p.currentCharacter;
  currentVolume = p.currentVolume;
  currentChapter = p.currentChapter;
  data = p.data;
}

function saveProject(){
  projects[currentProject] = {
    stage,
    currentCharacter,
    currentVolume,
    currentChapter,
    data
  };
  localStorage.setItem("novel_projects",JSON.stringify(projects));
  localStorage.setItem("currentProject",currentProject);
}

loadProject();

/* ================= 清理 ================= */

function clearAll(){
  localStorage.clear();
  alert("已清理，请刷新页面");
}

/* ================= 顶部步骤 ================= */

function drawSteps(){
  return `
  <div style="margin-bottom:12px;">
    <button onclick="jump('preset')" ${stage==='preset'?'style="background:#111;color:#fff"':''}>前期设定</button>
    <button onclick="jump('outline')" ${stage==='outline'?'style="background:#111;color:#fff"':''}>全书大纲</button>
    <button onclick="jump('characters')" ${stage==='characters'?'style="background:#111;color:#fff"':''}>角色库</button>
    <button onclick="jump('volume')" ${stage==='volume'?'style="background:#111;color:#fff"':''}>卷纲</button>
    <button onclick="jump('chapter')" ${stage==='chapter'?'style="background:#111;color:#fff"':''}>章节细纲</button>
  </div>`;
}

/* ================= 主渲染 ================= */

function draw(){
  var app=document.getElementById("app");
  if(!app) return;

  /* ===== 项目选择 ===== */
  var projectOptions = Object.keys(projects).map(name =>
    `<option value="${name}" ${name===currentProject?'selected':''}>${name}</option>`
  ).join("");

  var projectBar = `
    项目：
    <select onchange="switchProject(this.value)">${projectOptions}</select>
    <button onclick="newProject()">＋ 新建项目</button>
    <hr>
  `;

  /* ===== 前期设定 ===== */
  if(stage==="preset"){
    app.innerHTML=projectBar+drawSteps()+`
      <b>前期设定</b><br><br>
      世界观（手写）：<br>
      <textarea rows="6" oninput="data.world=this.value;saveProject();">${data.world||""}</textarea><br><br>
      脑洞生成：<br>
      <textarea rows="6" oninput="data.preset=this.value;saveProject();">${data.preset||""}</textarea>
    `;
    return;
  }

  /* ===== 全书大纲 ===== */
  if(stage==="outline"){
    app.innerHTML=projectBar+drawSteps()+`
      <b>全书大纲</b><br><br>
      <textarea rows="60" oninput="data.outline=this.value;saveProject();">${data.outline||""}</textarea>
    `;
    return;
  }

  /* ===== 角色库 ===== */
  if(stage==="characters"){
    if(data.characters.length===0){
      data.characters.push({name:"",importance:"",personality:"",identity:"",relations:"",traits:""});
    }
    var c=data.characters[currentCharacter];

    var options=data.characters.map((ch,i)=>{
      return `<option value="${i}" ${i===currentCharacter?'selected':''}>${ch.name||("角色"+(i+1))}</option>`;
    }).join("");

    app.innerHTML=projectBar+drawSteps()+`
      <b>角色库</b><br><br>
      <button onclick="addCharacter()">＋ 新增角色</button>
      <button onclick="removeCharacter()">－ 删除角色</button><br><br>

      当前角色：
      <select onchange="changeCharacter(this.value)">${options}</select><hr>

      姓名<br>
      <textarea class="small" oninput="c.name=this.value;saveProject();">${c.name||""}</textarea><br><br>

      角色重要性<br>
      <textarea class="small" oninput="c.importance=this.value;saveProject();">${c.importance||""}</textarea><br><br>

      性格<br>
      <textarea class="small" oninput="c.personality=this.value;saveProject();">${c.personality||""}</textarea><br><br>

      身份<br>
      <textarea class="medium" oninput="c.identity=this.value;saveProject();">${c.identity||""}</textarea><br><br>

      核心关系<br>
      <textarea class="medium" oninput="c.relations=this.value;saveProject();">${c.relations||""}</textarea><br><br>

      人物特性<br>
      <textarea class="medium" oninput="c.traits=this.value;saveProject();">${c.traits||""}</textarea>
    `;
    return;
  }

  /* ===== 卷纲 ===== */
  if(stage==="volume"){
    if(data.volumes.length===0){
      data.volumes.push({
        desc:"",characterArc:"",startState:"",goal:"",
        events:"",endState:"",chapterCount:1,
        chapters:[{summary:"",scene:"",beats:"",text:""}]
      });
    }

    var v=data.volumes[currentVolume];

    app.innerHTML=projectBar+drawSteps()+`
      <b>卷纲</b><br><br>
      <button onclick="addVolume()">＋ 增加一卷</button>
      <button onclick="removeVolume()">－ 减少一卷</button><br><br>

      当前卷：
      <select onchange="changeVolume(this.value)">
        ${data.volumes.map((_,i)=>`<option value="${i}" ${i===currentVolume?'selected':''}>第 ${i+1} 卷</option>`).join("")}
      </select><hr>

      卷简介
      <textarea style="height:120px" oninput="v.desc=this.value;saveProject();">${v.desc||""}</textarea><br><br>

      主要人物弧光
      <textarea style="height:90px" oninput="v.characterArc=this.value;saveProject();">${v.characterArc||""}</textarea>
    `;
    return;
  }

  /* ===== 章节细纲 ===== */
  if(stage==="chapter"){
    var v=data.volumes[currentVolume];
    if(!v.chapters || v.chapters.length===0){
      v.chapters=[{summary:"",scene:"",beats:"",text:""}];
    }
    var c=v.chapters[currentChapter];

    app.innerHTML=projectBar+drawSteps()+`
      <b>章节细纲</b><br><br>
      章节概述
      <textarea rows="4" oninput="c.summary=this.value;saveProject();">${c.summary||""}</textarea><br><br>

      场景拆分
      <textarea rows="4" oninput="c.scene=this.value;saveProject();">${c.scene||""}</textarea><br><br>

      剧情点
      <textarea rows="6" oninput="c.beats=this.value;saveProject();">${c.beats||""}</textarea><br><br>

      正文
      <textarea style="height:600px" oninput="c.text=this.value;saveProject();">${c.text||""}</textarea>
    `;
    return;
  }
}

/* ================= 操作函数 ================= */

function jump(s){ stage=s; saveProject(); draw(); }

function switchProject(name){
  saveProject();
  currentProject=name;
  loadProject();
  draw();
}

function newProject(){
  var name=prompt("新项目名称");
  if(!name || projects[name]) return;
  projects[name]=createEmptyProject();
  currentProject=name;
  loadProject();
  saveProject();
  draw();
}

function addCharacter(){
  data.characters.push({name:"",importance:"",personality:"",identity:"",relations:"",traits:""});
  currentCharacter=data.characters.length-1;
  saveProject(); draw();
}
function removeCharacter(){
  if(data.characters.length>1){
    data.characters.splice(currentCharacter,1);
    currentCharacter=Math.max(0,currentCharacter-1);
    saveProject(); draw();
  }
}

function changeCharacter(i){ currentCharacter=Number(i); saveProject(); draw(); }

function addVolume(){
  data.volumes.push({
    desc:"",characterArc:"",startState:"",goal:"",
    events:"",endState:"",chapterCount:1,
    chapters:[{summary:"",scene:"",beats:"",text:""}]
  });
  currentVolume=data.volumes.length-1;
  saveProject(); draw();
}
function removeVolume(){
  if(data.volumes.length>1){
    data.volumes.pop();
    currentVolume=Math.max(0,currentVolume-1);
    saveProject(); draw();
  }
}
function changeVolume(i){ currentVolume=Number(i); currentChapter=0; saveProject(); draw(); }

/* ================= 启动 ================= */
draw();
</script>

</body>
</html>