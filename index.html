<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>赛博文豪</title>
</head>
<body>

<h1>赛博文豪</h1>

<script>
/* ===== 基础状态 ===== */
const stages = ["idea", "setting", "outline", "volume", "chapter"];
let stage = localStorage.getItem("stage") || "idea";
let currentVolume = Number(localStorage.getItem("currentVolume")) || 0;

let data = JSON.parse(localStorage.getItem("data")) || {
  idea: "",
  setting: "",
  outline: "",
  volumes: []
};

const titleMap = {
  idea: "脑洞",
  setting: "世界观",
  outline: "全书大纲",
  volume: "卷纲",
  chapter: "章节细纲"
};

function save() {
  localStorage.setItem("data", JSON.stringify(data));
  localStorage.setItem("stage", stage);
  localStorage.setItem("currentVolume", currentVolume);
}

/* ===== 流程条 ===== */
function drawSteps() {
  return `
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;">
      ${stages.map(s => `
        <div onclick="jump('${s}')"
          style="padding:6px 14px;border-radius:20px;cursor:pointer;
          background:${s===stage?'#111':'#eee'};
          color:${s===stage?'#fff':'#333'};">
          ${titleMap[s]}
        </div>
      `).join("")}
    </div>
  `;
}

/* ===== 主绘制 ===== */
function drawPage() {
  document.body.innerHTML = `
    <h1>赛博文豪</h1>
    ${drawSteps()}
    ${drawStageContent()}
  `;
}

/* ===== 各阶段内容 ===== */
function drawStageContent() {

  /* 通用阶段（脑洞 / 世界观 / 全书大纲） */
  if (stage === "idea" || stage === "setting" || stage === "outline") {
    return `
      <p><b>当前阶段：${titleMap[stage]}</b></p>

      <textarea id="input"
        style="width:100%;height:220px;">${data[stage] || ""}</textarea>

      <div style="margin-top:12px;">
        <button onclick="generateCurrent()">生成${titleMap[stage]}</button>
      </div>
    `;
  }

  /* 卷纲阶段（不动你现有逻辑） */
  if (stage === "volume") {
    return `
      <p><b>当前阶段：卷纲</b></p>
      <p>（卷纲阶段结构保持不变）</p>
    `;
  }

  /* 章节细纲阶段（不动） */
  if (stage === "chapter") {
    return `
      <p><b>当前阶段：章节细纲</b></p>
      <p>（章节细纲阶段结构保持不变）</p>
    `;
  }

  return "";
}

/* ===== 生成占位逻辑（稳定） ===== */
function generateCurrent() {
  if (stage === "idea") {
    data.idea = "【脑洞生成示例】\n一个关于未来与人性的故事设想。";
  }
  if (stage === "setting") {
    data.setting = "【世界观生成示例】\n一个高度信息化却充满裂痕的社会。";
  }
  if (stage === "outline") {
    data.outline =
`【全书大纲示例】

第一幕：引子  
第二幕：冲突展开  
第三幕：危机升级  
第四幕：转折  
第五幕：结局`;
  }

  save();

  const input = document.getElementById("input");
  if (input) input.value = data[stage];
}

/* ===== 跳转 ===== */
function jump(t) {
  const input = document.getElementById("input");
  if (input) data[stage] = input.value;
  stage = t;
  save();
  drawPage();
}
function generateChapterSummaries(volumeIndex) {
  const v = data.volumes[volumeIndex];
  if (!v) return;

  const count = Number(v.chapterCount || 0);
  if (count <= 0) {
    alert("请先填写本卷章节数");
    return;
  }

  if (v.chapters && v.chapters.length > 0) {
    const ok = confirm("已存在章节概述，是否覆盖？");
    if (!ok) return;
  }

  const summaries = [];
  for (let i = 0; i < count; i++) {
    summaries.push({
      summary:
        `第 ${i + 1} 章：\n` +
        `本章围绕本卷主线展开关键情节，推动人物关系与冲突发展。\n` +
        `事件在本章中逐步升级，并为后续章节埋下伏笔。\n` +
        `同时揭示新的信息或转折点。`,
      detail: ""
    });
  }

  v.chapters = summaries;
  save();

  alert("本卷章节概述已生成，可在【章节细纲】阶段查看和修改。");
}

drawPage();
</script>

</body>
</html>