<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>赛博文豪</title>
<style>
body{font-family:sans-serif;}
.wrap{max-width:900px;margin:0 auto;}
textarea{width:100%;box-sizing:border-box;}
select,button{margin-right:6px;}
.stage-btn{margin-right:6px;}
.active{background:#111;color:#fff;}
.block{margin-bottom:20px;}
.warn{color:#b00;font-weight:bold;}
</style>
</head>
<body>

<h1 style="text-align:center;">赛博文豪</h1>
<div class="wrap"><div id="app"></div></div>

<script>
const stages=["preset","outline","volume","chapter"];
const titleMap={preset:"前期设定",outline:"全书大纲",volume:"卷纲",chapter:"章节细纲"};

let stage=localStorage.getItem("stage")||"preset";
let currentVolume=Number(localStorage.getItem("currentVolume"))||0;
let currentChapter=Number(localStorage.getItem("currentChapter"))||0;

let data=JSON.parse(localStorage.getItem("data"))||{
  preset:"",outline:"",volumes:[]
};

function save(){
  localStorage.setItem("stage",stage);
  localStorage.setItem("currentVolume",currentVolume);
  localStorage.setItem("currentChapter",currentChapter);
  localStorage.setItem("data",JSON.stringify(data));
}

function drawSteps(){
  return `<div class="block">${
    stages.map(s=>`<button class="stage-btn ${s===stage?"active":""}"
      onclick="jump('${s}')">${titleMap[s]}</button>`).join("")
  }</div>`;
}

function draw(){
  const app=document.getElementById("app");
  let html=drawSteps();

  if(stage==="preset"){
    html+=`
    <b>前期设定</b><br><br>
    <textarea rows="10" oninput="data.preset=this.value;save();">${data.preset}</textarea>`;
  }

  if(stage==="outline"){
    html+=`
    <b>全书大纲</b><br><br>
    <textarea rows="10" oninput="data.outline=this.value;save();">${data.outline}</textarea>`;
  }

  if(stage==="volume"){
    html+=`
    <b>卷纲</b><br><br>
    <button onclick="addVolume()">＋ 增加一卷</button>
    <button onclick="removeVolume()">－ 删除一卷</button><hr>`;
    data.volumes.forEach((v,i)=>{
      html+=`
      <div class="block">
      <b>第 ${i+1} 卷</b><br><br>
      卷简介：<br>
      <textarea rows="4" oninput="v.desc=this.value;save();">${v.desc}</textarea><br><br>
      本卷章节数：
      <input type="number" min="1"
        value="${v.chapterCount}"
        oninput="v.chapterCount=Number(this.value);save();">
      <br><br>
      <button onclick="genChapterOutline(${i})">根据卷简介生成章节概述</button>
      </div>`;
    });
  }

  if(stage==="chapter"){
    const v=data.volumes[currentVolume];
    if(!v||!v.chapters.length){
      html+=`<p class="warn">请先生成章节概述。</p>`;
      app.innerHTML=html;return;
    }
    const ch=v.chapters[currentChapter];
    html+=`
    第 <select onchange="currentChapter=Number(this.value);save();draw();">
      ${v.chapters.map((_,i)=>`<option value="${i}" ${i===currentChapter?"selected":""}>${i+1}</option>`).join("")}
    </select> 章<hr>

    <b>章节概述</b><br>
    <textarea rows="4" oninput="ch.outline=this.value;save();">${ch.outline}</textarea><br><br>

    <button onclick="genPoints()">根据章节概述生成剧情点</button><br><br>

    <b>章节剧情点</b><br>
    <textarea rows="8" oninput="ch.points=this.value;save();">${ch.points}</textarea>`;
  }

  app.innerHTML=html;
}

function jump(s){stage=s;save();draw();}
function addVolume(){
  data.volumes.push({desc:"",chapterCount:10,chapters:[]});
  save();draw();
}
function removeVolume(){data.volumes.pop();save();draw();}
function genChapterOutline(i){
  const v=data.volumes[i];
  v.chapters=[];
  const count=Number(v.chapterCount);
  for(let n=0;n<count;n++){
    v.chapters.push({outline:`第 ${n+1} 章概述`,points:""});
  }
  save();draw();
}
function genPoints(){
  const ch=data.volumes[currentVolume].chapters[currentChapter];
  ch.points="";
  for(let i=1;i<=12;i++) ch.points+=`剧情点 ${i}\n`;
  save();draw();
}

draw();
</script>
</body>
</html>