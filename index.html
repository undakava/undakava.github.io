<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>赛博文豪</title>
<style>
  body { font-family: sans-serif; }
  .wrap { max-width: 900px; margin: 0 auto; }
  textarea { width: 100%; box-sizing: border-box; }
  select, button { margin-right: 6px; }
  .stage-btn { margin-right:6px; }
  .active { background:#111;color:#fff; }
  .block { margin-bottom:20px; }
</style>
</head>
<body>

<h1 style="text-align:center;">赛博文豪</h1>
<div class="wrap">
  <div id="app"></div>
</div>

<script>
/* ===== 基础状态 ===== */
const stages = ["preset","outline","volume","chapter"];
const titleMap = {
  preset:"前期设定",
  outline:"全书大纲",
  volume:"卷纲",
  chapter:"章节细纲"
};

let stage = localStorage.getItem("stage") || "preset";
let currentVolume = Number(localStorage.getItem("currentVolume")) || 0;
let currentChapter = Number(localStorage.getItem("currentChapter")) || 0;

let data = JSON.parse(localStorage.getItem("data")) || {
  preset:"",
  outline:"",
  volumes:[]
};

function save(){
  localStorage.setItem("stage",stage);
  localStorage.setItem("currentVolume",currentVolume);
  localStorage.setItem("currentChapter",currentChapter);
  localStorage.setItem("data",JSON.stringify(data));
}

/* ===== 顶部导航 ===== */
function drawSteps(){
  return `
    <div class="block">
      ${stages.map(s=>`
        <button class="stage-btn ${s===stage?"active":""}"
          onclick="jump('${s}')">${titleMap[s]}</button>
      `).join("")}
    </div>
  `;
}

/* ===== 主渲染 ===== */
function draw(){
  const app = document.getElementById("app");
  let html = drawSteps();

  /* 前期设定 */
  if(stage==="preset"){
    html+=`
      <b>前期设定（脑洞 + 世界观）</b><br><br>
      <textarea rows="10"
        oninput="data.preset=this.value;save();">${data.preset}</textarea><br><br>
      <button onclick="data.preset='【脑洞占位】\\n\\n'+data.preset;save();draw();">
        生成脑洞
      </button>
      <button onclick="data.preset+='\\n\\n【世界观占位】';save();draw();">
        生成世界观
      </button>
    `;
  }

  /* 全书大纲 */
  if(stage==="outline"){
    html+=`
      <b>全书大纲</b><br><br>
      <textarea rows="10"
        oninput="data.outline=this.value;save();">${data.outline}</textarea><br><br>
      <button onclick="data.outline='【全书大纲占位】\\n'+data.preset;save();draw();">
        生成全书大纲
      </button>
    `;
  }

  /* 卷纲 */
  if(stage==="volume"){
    html+=`
      <b>卷纲</b><br><br>
      <button onclick="addVolume()">＋ 增加一卷</button>
      <button onclick="removeVolume()">－ 删除一卷</button>
      <br><br>
      <button onclick="genAllVolumeDesc()">根据全书大纲生成卷简介</button>
      <hr>
    `;
    data.volumes.forEach((v,i)=>{
      html+=`
        <div class="block">
          <b>第 ${i+1} 卷</b><br><br>
          卷简介：<br>
          <textarea rows="4"
            oninput="v.desc=this.value;save();">${v.desc||""}</textarea><br><br>
          本卷章节数：
          <input type="number" min="1" value="${v.chapterCount||10}"
            onchange="v.chapterCount=Number(this.value);save();">
          <br><br>
          <button onclick="genChapterOutline(${i})">
            根据卷简介生成章节概述
          </button>
        </div>
      `;
    });
  }

  /* 章节细纲（稳定单章模式） */
  if(stage==="chapter"){
    if(!data.volumes.length){
      html+="请先创建卷。";
    }else{
      const v = data.volumes[currentVolume];
      const ch = v.chapters[currentChapter];

      html+=`
        <b>章节细纲</b><br><br>

        第
        <select onchange="currentVolume=Number(this.value);currentChapter=0;save();draw();">
          ${data.volumes.map((_,i)=>`
            <option value="${i}" ${i===currentVolume?"selected":""}>${i+1}</option>
          `).join("")}
        </select>
        卷

        第
        <select onchange="currentChapter=Number(this.value);save();draw();">
          ${v.chapters.map((_,i)=>`
            <option value="${i}" ${i===currentChapter?"selected":""}>${i+1}</option>
          `).join("")}
        </select>
        章

        <hr>

        <b>章节概述</b><br>
        <textarea rows="4"
          oninput="ch.outline=this.value;save();">${ch.outline||""}</textarea><br><br>

        <button onclick="genPoints()">根据章节概述生成剧情点</button>
        <br><br>

        <b>章节剧情点（12 点）</b><br>
        <textarea rows="8"
          oninput="ch.points=this.value;save();">${ch.points||""}</textarea><br><br>

        <button onclick="genText()">生成正文</button>
      `;
    }
  }

  app.innerHTML = html;
}

/* ===== 操作函数 ===== */
function jump(s){ stage=s; save(); draw(); }

function addVolume(){
  data.volumes.push({desc:"",chapterCount:10,chapters:[]});
  save(); draw();
}
function removeVolume(){
  data.volumes.pop();
  save(); draw();
}

function genAllVolumeDesc(){
  data.volumes.forEach((v,i)=>{
    v.desc=`【第 ${i+1} 卷简介占位】\\n` + data.outline;
  });
  save(); draw();
}

function genChapterOutline(i){
  const v = data.volumes[i];
  v.chapters = [];
  for(let n=0;n<v.chapterCount;n++){
    v.chapters.push({outline:`第 ${n+1} 章概述占位`,points:"",text:""});
  }
  save(); draw();
}

function genPoints(){
  const ch = data.volumes[currentVolume].chapters[currentChapter];
  ch.points = "";
  for(let i=1;i<=12;i++){
    ch.points += `剧情点 ${i}\n`;
  }
  save(); draw();
}

function genText(){
  const ch = data.volumes[currentVolume].chapters[currentChapter];
  ch.text = "【正文占位】\n\n" + ch.points;
  save();
  alert("正文已生成（占位），数据已保存。");
}

draw();
</script>

</body>
</html>