<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>赛博文豪</title>
</head>
<body>

<h1>赛博文豪</h1>

<script>
/* ===== 基础状态 ===== */
const stages = ["idea", "setting", "outline", "volume", "chapter"];
let stage = localStorage.getItem("stage") || "idea";
let currentVolume = Number(localStorage.getItem("currentVolume")) || 0;

let data = JSON.parse(localStorage.getItem("data")) || {
  idea: "",
  setting: "",
  outline: "",
  volumes: []
};

const titleMap = {
  idea: "脑洞",
  setting: "世界观",
  outline: "全书大纲",
  volume: "卷纲",
  chapter: "章节细纲"
};

function save() {
  localStorage.setItem("data", JSON.stringify(data));
  localStorage.setItem("stage", stage);
  localStorage.setItem("currentVolume", currentVolume);
}

/* ===== 流程条 ===== */
function drawSteps() {
  return `
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;">
      ${stages.map(s => `
        <div onclick="jump('${s}')"
          style="padding:6px 14px;border-radius:20px;cursor:pointer;
          background:${s===stage?'#111':'#eee'};
          color:${s===stage?'#fff':'#333'};">
          ${titleMap[s]}
        </div>
      `).join("")}
    </div>
  `;
}

/* ===== 页面绘制 ===== */
function drawPage() {
  document.body.innerHTML = `
    <h1>赛博文豪</h1>
    ${drawSteps()}
    ${drawStage()}
  `;
}

/* ===== 各阶段 ===== */
function drawStage() {

  /* 脑洞 / 世界观 / 全书大纲 */
  if (stage === "idea" || stage === "setting" || stage === "outline") {
    return `
      <p><b>当前阶段：${titleMap[stage]}</b></p>
      <textarea id="input" style="width:100%;height:220px;">${data[stage] || ""}</textarea>
      <div style="margin-top:12px;">
        <button onclick="generateCurrent()">生成${titleMap[stage]}</button>
      </div>
    `;
  }

  /* ===== 卷纲阶段（最小稳定骨架） ===== */
  if (stage === "volume") {
    if (data.volumes.length === 0) {
      data.volumes.push({ title:"", desc:"", chapterCount:0, chapters:[] });
      save();
    }

    return `
      <p><b>当前阶段：卷纲</b></p>

      <div style="margin-bottom:12px;">
        卷数：
        <button onclick="addVolume()">＋</button>
        <button onclick="removeVolume()">－</button>
        <span>${data.volumes.length}</span>
      </div>

      <hr>

      ${data.volumes.map((v, i) => `
        <div style="border:1px solid #ccc;padding:10px;margin-bottom:12px;">
          <b>第 ${i+1} 卷</b><br><br>

          卷名：<br>
          <input style="width:100%;"
            value="${v.title || ""}"
            oninput="vUpdate(${i}, 'title', this.value)">
          <br><br>

          卷简介：<br>
          <textarea style="width:100%;height:80px;"
            oninput="vUpdate(${i}, 'desc', this.value)">${v.desc || ""}</textarea>
          <br><br>

          本卷章节数：<br>
          <input type="number" min="1" style="width:80px;"
            value="${v.chapterCount || 0}"
            oninput="vUpdate(${i}, 'chapterCount', this.value)">
          <br><br>

          <button onclick="generateChapterSummaries(${i})">
            根据卷纲生成章节概述
          </button>
        </div>
      `).join("")}
    `;
  }

  /* 章节细纲阶段（占位，不白屏） */
  if (stage === "chapter") {
    return `
      <p><b>当前阶段：章节细纲</b></p>
      <p>章节细纲阶段将在下一步展开</p>
    `;
  }

  return "";
}

/* ===== 生成占位 ===== */
function generateCurrent() {
  if (stage === "idea") data.idea = "【脑洞示例】一个故事的最初想法。";
  if (stage === "setting") data.setting = "【世界观示例】故事发生的背景。";
  if (stage === "outline") data.outline = "【全书大纲示例】起承转合。";
  save();
  const input = document.getElementById("input");
  if (input) input.value = data[stage];
}

/* ===== 卷操作 ===== */
function addVolume() {
  data.volumes.push({ title:"", desc:"", chapterCount:0, chapters:[] });
  save(); drawPage();
}
function removeVolume() {
  if (data.volumes.length > 1) data.volumes.pop();
  save(); drawPage();
}
function vUpdate(i, k, v) {
  data.volumes[i][k] = v;
  save();
}

/* ===== 章节概述生成（你刚才确认的逻辑） ===== */
function generateChapterSummaries(i) {
  const v = data.volumes[i];
  const count = Number(v.chapterCount || 0);
  if (count <= 0) {
    alert("请填写本卷章节数");
    return;
  }
  if (v.chapters && v.chapters.length > 0) {
    if (!confirm("已存在章节概述，是否覆盖？")) return;
  }
  v.chapters = [];
  for (let n = 0; n < count; n++) {
    v.chapters.push({
      summary:
        `第 ${n+1} 章：本章围绕本卷主线展开，推动情节与人物关系发展。\n` +
        `冲突在本章中逐步升级，并为后续章节埋下伏笔。\n` +
        `同时揭示新的信息或转折。`,
      detail: ""
    });
  }
  save();
  alert("章节概述已生成，可在章节细纲阶段查看");
}

/* ===== 跳转 ===== */
function jump(t) {
  const input = document.getElementById("input");
  if (input) data[stage] = input.value;
  stage = t;
  save();
  drawPage();
}

drawPage();
</script>

</body>
</html>