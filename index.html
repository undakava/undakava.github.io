<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>赛博文豪</title>
</head>
<body>

<h1>赛博文豪</h1>

<script>
const stages = ["idea", "setting", "outline", "volume", "chapter"];
let stage = localStorage.getItem("stage") || "idea";
let currentVolume = Number(localStorage.getItem("currentVolume")) || 0;
let currentChapter = Number(localStorage.getItem("currentChapter")) || 0;

let data = JSON.parse(localStorage.getItem("data")) || {
  idea: "",
  setting: "",
  outline: "",
  volumes: []
};

const titleMap = {
  idea: "脑洞",
  setting: "世界观",
  outline: "全书大纲",
  volume: "卷纲",
  chapter: "章节细纲"
};

function save() {
  localStorage.setItem("data", JSON.stringify(data));
  localStorage.setItem("stage", stage);
  localStorage.setItem("currentVolume", currentVolume);
  localStorage.setItem("currentChapter", currentChapter);
}

function drawSteps() {
  return `
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;">
      ${stages.map(s => `
        <div onclick="jump('${s}')"
          style="padding:6px 14px;border-radius:20px;cursor:pointer;
          background:${s===stage?'#111':'#eee'};
          color:${s===stage?'#fff':'#333'};">
          ${titleMap[s]}
        </div>
      `).join("")}
    </div>
  `;
}

function drawPage() {
  document.body.innerHTML = `
    <h1>赛博文豪</h1>
    ${drawSteps()}
    ${drawStage()}
  `;
}

function drawStage() {

  if (stage === "idea" || stage === "setting" || stage === "outline") {
    return `
      <p><b>当前阶段：${titleMap[stage]}</b></p>
      <textarea id="input" style="width:100%;height:220px;">${data[stage] || ""}</textarea>
      <div style="margin-top:12px;">
        <button onclick="generateCurrent()">生成${titleMap[stage]}</button>
      </div>
    `;
  }

  if (stage === "volume") {
    if (data.volumes.length === 0) {
      data.volumes.push({ title:"", desc:"", chapterCount:0, chapters:[] });
      save();
    }

    return `
      <p><b>当前阶段：卷纲</b></p>

      <div>
        卷数：
        <button onclick="addVolume()">＋</button>
        <button onclick="removeVolume()">－</button>
        <span>${data.volumes.length}</span>
      </div>
      <hr>

      ${data.volumes.map((v,i)=>`
        <div style="border:1px solid #ccc;padding:10px;margin-bottom:12px;">
          <b>第 ${i+1} 卷</b><br><br>

          卷名：<br>
          <input style="width:100%;" value="${v.title||""}"
            oninput="vUpdate(${i},'title',this.value)"><br><br>

          卷简介：<br>
          <textarea style="width:100%;height:80px;"
            oninput="vUpdate(${i},'desc',this.value)">${v.desc||""}</textarea><br><br>

          本卷章节数：<br>
          <input type="number" min="1" style="width:80px;"
            value="${v.chapterCount||0}"
            oninput="vUpdate(${i},'chapterCount',this.value)"><br><br>

          <button onclick="generateChapterSummaries(${i})">
            根据卷纲生成章节概述
          </button>
        </div>
      `).join("")}
    `;
  }

  if (stage === "chapter") {
  const v = data.volumes[currentVolume];
  if (!v || !v.chapters || v.chapters.length === 0) {
    return `<p>请先在卷纲阶段生成章节概述</p>`;
  }

  const c = v.chapters[currentChapter];

  return `
    <p><b>当前阶段：章节细纲</b></p>

    当前卷：
    <select onchange="switchVolume(this.value)">
      ${data.volumes.map((_,i)=>`
        <option value="${i}" ${i===currentVolume?"selected":""}>
          第 ${i+1} 卷
        </option>`).join("")}
    </select>

    当前章：
    <select onchange="switchChapter(this.value)">
      ${v.chapters.map((_,i)=>`
        <option value="${i}" ${i===currentChapter?"selected":""}>
          第 ${i+1} 章
        </option>`).join("")}
    </select>

    <hr>

    <b>章节概述</b><br>
    <textarea style="width:100%;height:100px;"
      oninput="updateChapter('summary',this.value)">${c.summary||""}</textarea><br>

    <button onclick="genDetailFromSummary()">
      根据章节概述生成章节剧情点
    </button>

    <hr>

    <b>章节剧情点（12 点）</b><br>
    <textarea style="width:100%;height:180px;"
      oninput="updateChapter('detail',this.value)">${
        c.detail && c.detail.trim()
          ? c.detail
          : (
`【剧情点 1】
【剧情点 2】
【剧情点 3】
【剧情点 4】
【剧情点 5】
【剧情点 6】
【剧情点 7】
【剧情点 8】
【剧情点 9】
【剧情点 10】
【剧情点 11】
【剧情点 12】`
          )
      }</textarea><br>

    <button onclick="genContentFromDetail()">
      根据章节剧情点生成章节正文
    </button>
  `;
}

function generateCurrent() {
  if (stage==="idea") data.idea="【脑洞示例】";
  if (stage==="setting") data.setting="【世界观示例】";
  if (stage==="outline") data.outline="【全书大纲示例】";
  save();
  const input=document.getElementById("input");
  if(input) input.value=data[stage];
}

function addVolume(){ data.volumes.push({title:"",desc:"",chapterCount:0,chapters:[]}); save(); drawPage();}
function removeVolume(){ if(data.volumes.length>1)data.volumes.pop(); save(); drawPage();}
function vUpdate(i,k,v){ data.volumes[i][k]=v; save(); }

function generateChapterSummaries(i){
  const v=data.volumes[i];
  const n=Number(v.chapterCount||0);
  if(n<=0){alert("请填写章节数");return;}
  if(v.chapters.length>0&&!confirm("覆盖已有章节概述？"))return;
  v.chapters=[];
  for(let x=0;x<n;x++){
    v.chapters.push({summary:`第 ${x+1} 章：本章推进主线并制造冲突。`,detail:""});
  }
  save();
}

function switchVolume(i){ currentVolume=Number(i); currentChapter=0; save(); drawPage();}
function switchChapter(i){ currentChapter=Number(i); save(); drawPage();}
function updateChapter(k,v){ data.volumes[currentVolume].chapters[currentChapter][k]=v; save();}

function jump(t){
  const input=document.getElementById("input");
  if(input) data[stage]=input.value;
  stage=t;
  save();
  drawPage();
}

drawPage();

function genDetailFromSummary(){
  const c = data.volumes[currentVolume].chapters[currentChapter];
  if(c.detail && c.detail.trim()){
    if(!confirm("已有章节剧情点，是否覆盖？")) return;
  }
  c.detail =
`【剧情点 1】${c.summary || ""}
【剧情点 2】
【剧情点 3】
【剧情点 4】
【剧情点 5】
【剧情点 6】
【剧情点 7】
【剧情点 8】
【剧情点 9】
【剧情点 10】
【剧情点 11】
【剧情点 12】`;
  save();
  drawPage();
}

function genContentFromDetail(){
  const c = data.volumes[currentVolume].chapters[currentChapter];
  if(c.content && c.content.trim()){
    if(!confirm("已有章节正文，是否覆盖？")) return;
  }
  c.content =
`【章节正文（草稿）】

${c.detail}

（正文由剧情点扩写而成，占位示例）`;
  save();
}

</script>

</body>
</html>