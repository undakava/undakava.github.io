<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>èµ›åšæ–‡è±ª</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    textarea { box-sizing: border-box; }
    select, button { margin: 4px 0; }
    .step { padding: 6px 14px; border-radius: 20px; cursor: pointer; }
    .active { background:#111; color:#fff; }
    .inactive { background:#eee; color:#333; }
    hr { margin: 20px 0; }
  </style>
</head>
<body>

<h1>èµ›åšæ–‡è±ª</h1>
<div id="app"></div>

<script>
/* ========= åŸºç¡€æ•°æ® ========= */
const stages = ["idea","setting","outline","volume","chapter"];
const titleMap = {
  idea:"è„‘æ´",
  setting:"ä¸–ç•Œè§‚",
  outline:"å…¨ä¹¦å¤§çº²",
  volume:"å·çº²",
  chapter:"ç« èŠ‚ç»†çº²"
};

let stage = localStorage.getItem("stage") || "idea";
let currentVolume = Number(localStorage.getItem("currentVolume")) || 0;
let currentChapter = Number(localStorage.getItem("currentChapter")) || 0;

let data = JSON.parse(localStorage.getItem("data")) || {
  idea:"",
  setting:"",
  outline:"",
  volumes:[]
};

function save(){
  localStorage.setItem("data", JSON.stringify(data));
  localStorage.setItem("stage", stage);
  localStorage.setItem("currentVolume", currentVolume);
  localStorage.setItem("currentChapter", currentChapter);
}

/* ========= é€šç”¨ UI ========= */
function drawSteps(){
  return `
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;">
      ${stages.map(s=>`
        <div class="step ${s===stage?'active':'inactive'}"
             onclick="jump('${s}')">${titleMap[s]}</div>
      `).join("")}
    </div>
  `;
}

/* ========= é¡µé¢æ¸²æŸ“ ========= */
function draw(){
  const app = document.getElementById("app");
  app.innerHTML = "";

  /* é€šç”¨é˜¶æ®µ */
  if(stage!=="volume" && stage!=="chapter"){
    app.innerHTML = `
      ${drawSteps()}
      <b>å½“å‰é˜¶æ®µï¼š${titleMap[stage]}</b><br><br>
      <textarea id="input" style="width:100%;height:260px;">${data[stage]||""}</textarea>
    `;
    return;
  }

  /* å·çº²é˜¶æ®µ */
  if(stage==="volume"){
    app.innerHTML = `
      ${drawSteps()}
      <b>å½“å‰é˜¶æ®µï¼šå·çº²</b><br><br>
      <button onclick="addVolume()">ï¼‹ å¢åŠ ä¸€å·</button>
      <button onclick="removeVolume()">ï¼ åˆ é™¤æœ€åä¸€å·</button>
      <hr>
      ${data.volumes.map((v,i)=>`
        <div style="margin-bottom:20px;">
          <b>ç¬¬ ${i+1} å·</b><br>
          å·åï¼š<br>
          <input style="width:60%;" value="${v.title||""}"
            oninput="updateVolume(${i},'title',this.value)"><br><br>
          å·ç®€ä»‹ï¼š<br>
          <textarea style="width:100%;height:80px;"
            oninput="updateVolume(${i},'desc',this.value)">${v.desc||""}</textarea>
        </div>
      `).join("")}
    `;
    return;
  }

  /* ç« èŠ‚ç»†çº²é˜¶æ®µ */
if(stage==="chapter"){
  const v = data.volumes[currentVolume];
  if(!v){
    app.innerHTML = drawSteps() + "<p>è¯·å…ˆåˆ›å»ºå·çº²</p>";
    return;
  }

  // ğŸ‘‰ å…³é”®å…œåº•ï¼šä¿è¯è‡³å°‘æœ‰ 1 ç« 
  if(!Array.isArray(v.chapters)){
    v.chapters = [];
  }
  if(v.chapters.length === 0){
    v.chapters.push({
      summary: "",
      points: Array(12).fill("")
    });
    currentChapter = 0;
    save();
  }

  const chapters = v.chapters;
  const ch = chapters[currentChapter];

  app.innerHTML = `
    ${drawSteps()}
    <b>å½“å‰é˜¶æ®µï¼šç« èŠ‚ç»†çº²</b><br><br>

    å½“å‰å·ï¼š
    <select onchange="switchVolume(this.value)">
      ${data.volumes.map((_,i)=>`
        <option value="${i}" ${i===currentVolume?"selected":""}>
          ç¬¬ ${i+1} å·
        </option>
      `).join("")}
    </select>

    å½“å‰ç« ï¼š
    <select onchange="switchChapter(this.value)">
      ${chapters.map((_,i)=>`
        <option value="${i}" ${i===currentChapter?"selected":""}>
          ç¬¬ ${i+1} ç« 
        </option>
      `).join("")}
    </select>

    <hr>

    <b>ç« èŠ‚æ¦‚è¿°</b><br>
    <textarea style="width:100%;height:100px;"
      oninput="updateChapterField('summary',this.value)">
      ${ch.summary || ""}
    </textarea><br>

    <button onclick="genPoints()">æ ¹æ®å·ç®€ä»‹ & ç« èŠ‚æ¦‚è¿°ç”Ÿæˆç« èŠ‚ç»†çº²</button>

    <hr>

    <b>ç« èŠ‚ç»†çº²ï¼ˆ12 ä¸ªå‰§æƒ…ç‚¹ï¼‰</b><br><br>
    ${ch.points.map((p,i)=>`
      å‰§æƒ…ç‚¹ ${i+1}ï¼š<br>
      <textarea style="width:100%;height:60px;"
        oninput="updatePoint(${i},this.value)">${p}</textarea><br><br>
    `).join("")}
  `;
}
}

/* ========= å·æ“ä½œ ========= */
function addVolume(){
  data.volumes.push({title:"",desc:"",chapters:[]});
  save(); draw();
}
function removeVolume(){
  if(data.volumes.length>0){
    data.volumes.pop();
    currentVolume = Math.max(0,currentVolume-1);
  }
  save(); draw();
}
function updateVolume(i,f,v){ data.volumes[i][f]=v; save(); }

/* ========= ç« èŠ‚æ“ä½œ ========= */
function switchVolume(i){
  currentVolume = Number(i);
  currentChapter = 0;
  save(); draw();
}
function switchChapter(i){
  currentChapter = Number(i);
  save(); draw();
}
function ensureChapter(){
  const v = data.volumes[currentVolume];
  if(!v.chapters[currentChapter]){
    v.chapters[currentChapter] = {
      summary:"",
      points:Array(12).fill("")
    };
  }
}
function updateChapterField(f,v){
  ensureChapter();
  data.volumes[currentVolume].chapters[currentChapter][f]=v;
  save();
}
function updatePoint(i,v){
  ensureChapter();
  data.volumes[currentVolume].chapters[currentChapter].points[i]=v;
  save();
}
function genPoints(){
  ensureChapter();
  const pts = [];
  for(let i=0;i<12;i++){
    pts.push(`ç¬¬ ${i+1} ä¸ªå‰§æƒ…ç‚¹ï¼ˆå ä½ï¼‰`);
  }
  data.volumes[currentVolume].chapters[currentChapter].points = pts;
  save(); draw();
}

/* ========= è·³è½¬ ========= */
function jump(t){
  const input = document.getElementById("input");
  if(input) data[stage]=input.value;
  stage = t;
  save(); draw();
}

draw();
// â€”â€” å®‰å…¨æµ‹è¯•ç”¨ç”ŸæˆæŒ‰é’®ï¼ˆåªä½œç”¨äºå…¨ä¹¦å¤§çº²ï¼‰â€”â€”
// â€”â€” å…¨ä¹¦å¤§çº²é˜¶æ®µï¼šå®‰å…¨æŒ‚è½½ç”ŸæˆæŒ‰é’® â€”â€”
function mountOutlineButton(){
  if(stage !== "outline") return;

  const app = document.getElementById("app");
  if(!app) return;

  // é˜²æ­¢é‡å¤æ’æŒ‰é’®
  if(document.getElementById("outlineGenBtn")) return;

  const btn = document.createElement("button");
  btn.id = "outlineGenBtn";
  btn.innerText = "ç”Ÿæˆå…¨ä¹¦å¤§çº²ï¼ˆå ä½ï¼‰";
  btn.style.display = "block";
  btn.style.marginTop = "12px";

  btn.onclick = () => {
    data.outline =
`ã€å…¨ä¹¦å¤§çº²ï¼ˆå ä½ç¤ºä¾‹ï¼‰ã€‘

ç¬¬ä¸€å¹•ï¼šæ•…äº‹å¼•å­ä¸ä¸»è§’ç™»åœº  
ç¬¬äºŒå¹•ï¼šå†²çªå‡çº§ä¸ä¸–ç•Œå±•å¼€  
ç¬¬ä¸‰å¹•ï¼šé‡å¤§è½¬æŠ˜ä¸å±æœº  
ç¬¬å››å¹•ï¼šç»ˆå±€å¯¹æŠ—ä¸çœŸç›¸  
ç¬¬äº”å¹•ï¼šç»“å±€ä¸ä½™æ³¢`;

    save();

    // è‡ªåŠ¨åŒæ­¥æ–‡æœ¬æ¡†å†…å®¹ï¼ˆä¸é‡ç»˜é¡µé¢ï¼‰
    const input = document.getElementById("input");
    if(input){
      input.value = data.outline;
    }
  };

  app.appendChild(btn);
}

// æ¯æ¬¡æ¸²æŸ“åå°è¯•æŒ‚æŒ‰é’®
setInterval(mountOutlineButton, 200);

</script>

</body>
</html>