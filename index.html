<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>赛博文豪</title>
</head>
<body>

<h1>赛博文豪</h1>
<div id="app"></div>

<script>
/* ====== 基础状态 ====== */
const stages = ["idea","setting","outline","volume","chapter"];
const titleMap = {
  idea:"脑洞",
  setting:"世界观",
  outline:"全书大纲",
  volume:"卷纲",
  chapter:"章节细纲"
};

let stage = localStorage.getItem("stage") || "idea";
let currentVolume = Number(localStorage.getItem("currentVolume")) || 0;
let currentChapter = Number(localStorage.getItem("currentChapter")) || 0;

let data = JSON.parse(localStorage.getItem("data")) || {
  idea:"",
  setting:"",
  outline:"",
  volumes:[]
};

function save(){
  localStorage.setItem("stage",stage);
  localStorage.setItem("currentVolume",currentVolume);
  localStorage.setItem("currentChapter",currentChapter);
  localStorage.setItem("data",JSON.stringify(data));
}

/* ====== 步骤条 ====== */
function drawSteps(){
  return `
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      ${stages.map(s=>`
        <button onclick="jump('${s}')"
          style="padding:6px 12px;
          ${s===stage?"background:#111;color:#fff;":"background:#eee;"}">
          ${titleMap[s]}
        </button>
      `).join("")}
    </div>
  `;
}

/* ====== 主渲染 ====== */
function draw(){
  const app = document.getElementById("app");

  /* 通用文本阶段 */
  if(stage==="idea"||stage==="setting"||stage==="outline"){
    app.innerHTML = `
      ${drawSteps()}
      <p><b>${titleMap[stage]}</b></p>
      <textarea id="mainInput" style="width:100%;height:220px;">${data[stage]}</textarea>
      <br><br>
      <button onclick="generateText()">生成${titleMap[stage]}</button>
    `;
    return;
  }

  /* ====== 卷纲 ====== */
  if(stage==="volume"){
    app.innerHTML = `
      ${drawSteps()}
      <p><b>卷纲</b></p>

      <button onclick="addVolume()">＋ 增加一卷</button>
      <button onclick="removeVolume()">－ 删除一卷</button>
      <hr>

      ${data.volumes.map((v,i)=>`
        <div style="margin-bottom:20px;">
          <b>第 ${i+1} 卷</b><br>
          卷简介：<br>
          <textarea style="width:100%;height:80px;"
            oninput="vDesc(${i},this.value)">${v.desc||""}</textarea>
        </div>
      `).join("")}
    `;
    return;
  }

  /* ====== 章节细纲 ====== */
  if(stage==="chapter"){
    const v = data.volumes[currentVolume] || {chapters:[]};
    const chapters = v.chapters || [];

    app.innerHTML = `
      ${drawSteps()}
      <p><b>章节细纲</b></p>

      当前卷：
      <select onchange="switchVolume(this.value)">
        ${data.volumes.map((_,i)=>`
          <option value="${i}" ${i===currentVolume?"selected":""}>
            第 ${i+1} 卷
          </option>
        `).join("")}
      </select>

      <br><br>
      <button onclick="addChapter()">＋ 增加一章</button>
      <button onclick="removeChapter()">－ 删除一章</button>

      <hr>

      当前章：
      <select onchange="switchChapter(this.value)">
        ${chapters.map((_,i)=>`
          <option value="${i}" ${i===currentChapter?"selected":""}>
            第 ${i+1} 章
          </option>
        `).join("")}
      </select>

      <br><br>
      <textarea style="width:100%;height:160px;"
        oninput="updateChapter(this.value)">
        ${chapters[currentChapter]||""}
      </textarea>

      <br><br>
      <button onclick="generateChapter()">生成本章细纲</button>
    `;
  }
}

/* ====== 操作函数 ====== */
function jump(s){
  const input = document.getElementById("mainInput");
  if(input) data[stage]=input.value;
  stage=s;
  save(); draw();
}

function generateText(){
  data[stage] = `【${titleMap[stage]} · 占位生成】`;
  save(); draw();
}

function addVolume(){
  data.volumes.push({desc:"",chapters:[]});
  save(); draw();
}
function removeVolume(){
  data.volumes.pop();
  currentVolume = Math.max(0,currentVolume-1);
  save(); draw();
}
function vDesc(i,v){ data.volumes[i].desc=v; save(); }

function switchVolume(i){
  currentVolume=Number(i);
  currentChapter=0;
  save(); draw();
}
function addChapter(){
  data.volumes[currentVolume].chapters.push("");
  save(); draw();
}
function removeChapter(){
  data.volumes[currentVolume].chapters.pop();
  currentChapter=0;
  save(); draw();
}
function switchChapter(i){
  currentChapter=Number(i);
  save(); draw();
}
function updateChapter(v){
  data.volumes[currentVolume].chapters[currentChapter]=v;
  save();
}
function generateChapter(){
  data.volumes[currentVolume].chapters[currentChapter] =
    "【本章细纲 · 占位生成】";
  save(); draw();
}

/* ====== 启动 ====== */
draw();
</script>

</body>
</html>