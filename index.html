<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>赛博文豪</title>
</head>
<body>

<h1 style="text-align:center;">赛博文豪</h1>

<div style="max-width:900px;margin:0 auto;">
  <div id="app"></div>
</div>

<script>
/* ===== 状态 ===== */
const stages = ["pre","outline","volume","chapter"];
const titleMap = {
  pre:"前期设定",
  outline:"全书大纲",
  volume:"卷纲",
  chapter:"章节细纲"
};

let stage = localStorage.getItem("stage") || "pre";
let currentVolume = Number(localStorage.getItem("currentVolume")) || 0;
let currentChapter = Number(localStorage.getItem("currentChapter")) || 0;

let data = JSON.parse(localStorage.getItem("data")) || {
  preText:"",
  outline:"",
  volumes:[]
};

function save(){
  localStorage.setItem("stage",stage);
  localStorage.setItem("currentVolume",currentVolume);
  localStorage.setItem("currentChapter",currentChapter);
  localStorage.setItem("data",JSON.stringify(data));
}

/* ===== 顶部导航 ===== */
function drawSteps(){
  return `
    <div style="margin-bottom:12px;">
      ${stages.map(s=>`
        <button onclick="jump('${s}')"
          style="margin-right:6px;${s===stage?"background:#111;color:#fff;":"background:#eee;"}">
          ${titleMap[s]}
        </button>
      `).join("")}
    </div>
  `;
}

/* ===== 主渲染 ===== */
function draw(){
  const app=document.getElementById("app");

  /* ===== 前期设定 ===== */
  if(stage==="pre"){
    app.innerHTML=`
      ${drawSteps()}
      <p><b>前期设定</b></p>
      <textarea id="preInput" style="width:100%;height:160px;">${data.preText}</textarea>
      <br><br>
      <button onclick="genIdea()">生成脑洞</button>
      <button onclick="genWorld()">生成世界观</button>
    `;
    return;
  }

  /* ===== 全书大纲 ===== */
  if(stage==="outline"){
    app.innerHTML=`
      ${drawSteps()}
      <p><b>全书大纲</b></p>
      <textarea id="outlineInput" style="width:100%;height:160px;">${data.outline}</textarea>
      <br><br>
      <button onclick="genOutline()">生成全书大纲</button>
    `;
    return;
  }

  /* ===== 卷纲 ===== */
  if(stage==="volume"){
    app.innerHTML=`
      ${drawSteps()}
      <p><b>卷纲</b></p>

      <button onclick="addVolume()">＋ 增加一卷</button>
      <button onclick="removeVolume()">－ 删除一卷</button>
      <br><br>

      <button onclick="genAllVolumeDesc()">根据全书大纲生成卷简介</button>
      <hr>

      ${data.volumes.map((v,i)=>`
        <div style="margin-bottom:20px;">
          <b>第 ${i+1} 卷</b><br><br>

          卷简介：<br>
          <textarea style="width:100%;height:56px;"
            oninput="updateVolumeDesc(${i},this.value)">${v.desc||""}</textarea><br><br>

          本卷章节数：
          <input type="number" min="1" value="${v.chapterCount}"
            onchange="updateChapterCount(${i},this.value)">
          <br><br>

          <button onclick="genChapterOutline(${i})">
            根据卷简介生成章节概述
          </button>
        </div>
      `).join("")}
    `;
    return;
  }

  /* ===== 章节细纲 ===== */
  if(stage==="chapter"){
    const v=data.volumes[currentVolume];
    if(!v||!v.chapters||v.chapters.length===0){
      app.innerHTML=`${drawSteps()}<p>请先在卷纲阶段生成章节概述</p>`;
      return;
    }
    const ch=v.chapters[currentChapter];

    app.innerHTML=`
      ${drawSteps()}
      <p><b>章节细纲</b></p>

      第
      <select onchange="changeVolume(this.value)">
        ${data.volumes.map((_,i)=>`
          <option value="${i}" ${i===currentVolume?"selected":""}>${i+1}</option>
        `).join("")}
      </select>
      卷
      第
      <select onchange="changeChapter(this.value)">
        ${v.chapters.map((_,i)=>`
          <option value="${i}" ${i===currentChapter?"selected":""}>${i+1}</option>
        `).join("")}
      </select>
      章

      <br><br>

      章节概述：<br>
      <textarea style="width:100%;height:72px;"
        oninput="updateChapterSummary(this.value)">${ch.summary||""}</textarea><br>
      <button onclick="genChapterPoints()">根据章节概述生成剧情点</button>

      <br><br>

      剧情点（12点）：<br>
      <textarea style="width:100%;height:140px;"
        oninput="updateChapterPoints(this.value)">${ch.points||""}</textarea><br><br>

      <button onclick="genChapterText()">生成正文</button>
    `;
  }
}

/* ===== 跳转 ===== */
function jump(s){
  if(stage==="pre"){
    data.preText=document.getElementById("preInput")?.value||"";
  }
  if(stage==="outline"){
    data.outline=document.getElementById("outlineInput")?.value||"";
  }
  stage=s;
  save();draw();
}

/* ===== 前期设定生成 ===== */
function genIdea(){
  let t=data.preText||"";
  data.preText="【脑洞】\n占位生成内容\n\n"+t;
  save();draw();
}
function genWorld(){
  let t=data.preText||"";
  data.preText=t+"\n\n【世界观】\n占位生成内容";
  save();draw();
}

/* ===== 全书大纲 ===== */
function genOutline(){
  data.outline="【全书大纲占位生成】\n\n"+data.preText;
  save();draw();
}

/* ===== 卷纲 ===== */
function addVolume(){
  data.volumes.push({desc:"",chapterCount:10,chapters:[]});
  save();draw();
}
function removeVolume(){
  data.volumes.pop();
  save();draw();
}
function updateVolumeDesc(i,v){data.volumes[i].desc=v;save();}
function updateChapterCount(i,v){data.volumes[i].chapterCount=Number(v);save();}
function genAllVolumeDesc(){
  if(!data.outline){alert("请先填写全书大纲");return;}
  data.volumes.forEach((v,i)=>{
    v.desc="【第 "+(i+1)+" 卷简介占位】";
  });
  save();draw();
}
function genChapterOutline(i){
  const v=data.volumes[i];
  v.chapters=[];
  for(let n=0;n<v.chapterCount;n++){
    v.chapters.push({summary:"第 "+(n+1)+" 章概述",points:""});
  }
  save();
}

/* ===== 章节细纲 ===== */
function changeVolume(v){
  currentVolume=Number(v);
  currentChapter=0;
  save();draw();
}
function changeChapter(c){
  currentChapter=Number(c);
  save();draw();
}
function updateChapterSummary(v){
  data.volumes[currentVolume].chapters[currentChapter].summary=v;
  save();
}
function updateChapterPoints(v){
  data.volumes[currentVolume].chapters[currentChapter].points=v;
  save();
}
function genChapterPoints(){
  data.volumes[currentVolume].chapters[currentChapter].points="【12个剧情点占位】";
  save();draw();
}
function genChapterText(){
  alert("正文阶段后续接入");
}

draw();
</script>

</body>
</html>